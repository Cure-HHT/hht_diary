# IMPLEMENTS REQUIREMENTS:
#   REQ-d00005: Sponsor Configuration Detection Implementation
#   REQ-d00030: CI/CD Environment Parity
#   REQ-p00008: User Account Management
#   REQ-o00081: Code Quality and Static Analysis (analyze job)
#   REQ-o00082: Automated Test Execution (unit-tests, integration-tests, coverage jobs)
#
# CI workflow for diary_server and diary_functions
# Runs unit tests, integration tests (with PostgreSQL), and static analysis
# using CI container + Docker Compose PostgreSQL sidecar.

name: Diary Server CI

permissions:
  contents: read
  packages: read

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test:
    name: Diary Server CI
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect relevant changes
        id: filter
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "relevant=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          CHANGED=$(git diff --name-only ${{ github.event.pull_request.base.sha || 'HEAD~1' }} ${{ github.sha }} | grep -E '^apps/daily-diary/|^database/|^\.github/workflows/diary-server-ci\.yml$' || true)
          if [ -n "$CHANGED" ]; then
            echo "relevant=true" >> $GITHUB_OUTPUT
          else
            echo "relevant=false" >> $GITHUB_OUTPUT
          fi

      - name: Start CI container
        if: steps.filter.outputs.relevant == 'true'
        uses: ./.github/actions/start-ci-container
        with:
          profile: db
          ghcr-token: ${{ secrets.GITHUB_TOKEN }}

      # ---------------------------------------------------------------
      # Create sponsor_portal database (compose provides clinical_diary_test)
      # ---------------------------------------------------------------
      - name: Create sponsor_portal database
        if: steps.filter.outputs.relevant == 'true'
        working-directory: tools/dev-env
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T \
            -e PGPASSWORD=postgres \
            ci bash -c "psql -h postgres -U postgres -c 'CREATE DATABASE sponsor_portal;'" || true

      # ---------------------------------------------------------------
      # Static analysis + formatting
      # ---------------------------------------------------------------
      - name: Install dependencies
        if: steps.filter.outputs.relevant == 'true'
        working-directory: tools/dev-env
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T ci bash -c "
            cd /workspace/src/apps/daily-diary/diary_functions && dart pub get
            cd /workspace/src/apps/daily-diary/diary_server && dart pub get
          "

      - name: Analyze diary_functions
        if: steps.filter.outputs.relevant == 'true'
        working-directory: tools/dev-env
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T ci bash -c "
            cd /workspace/src/apps/daily-diary/diary_functions
            dart analyze --fatal-infos
          "

      - name: Analyze diary_server
        if: steps.filter.outputs.relevant == 'true'
        working-directory: tools/dev-env
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T ci bash -c "
            cd /workspace/src/apps/daily-diary/diary_server
            dart analyze --fatal-infos
          "

      - name: Check formatting
        if: steps.filter.outputs.relevant == 'true'
        working-directory: tools/dev-env
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T ci bash -c "
            dart format --set-exit-if-changed /workspace/src/apps/daily-diary/diary_functions
            dart format --set-exit-if-changed /workspace/src/apps/daily-diary/diary_server
          "

      # ---------------------------------------------------------------
      # Unit tests
      # ---------------------------------------------------------------
      - name: Run diary_functions unit tests
        if: steps.filter.outputs.relevant == 'true'
        working-directory: tools/dev-env
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T ci bash -c "
            cd /workspace/src/apps/daily-diary/diary_functions
            dart test test/
          "

      - name: Run diary_server unit tests
        if: steps.filter.outputs.relevant == 'true'
        working-directory: tools/dev-env
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T ci bash -c "
            cd /workspace/src/apps/daily-diary/diary_server
            dart test test/
          "

      # ---------------------------------------------------------------
      # Schema deploy for integration tests
      # ---------------------------------------------------------------
      - name: Deploy database schema
        if: steps.filter.outputs.relevant == 'true'
        working-directory: tools/dev-env
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T \
            -e PGPASSWORD=postgres \
            ci bash -c "cd /workspace/src && psql -h postgres -U postgres -d sponsor_portal --set ON_ERROR_STOP=1 -f database/init.sql"

      # ---------------------------------------------------------------
      # Integration tests
      # ---------------------------------------------------------------
      - name: Run diary_functions integration tests
        if: steps.filter.outputs.relevant == 'true'
        working-directory: tools/dev-env
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T \
            -e DB_HOST=postgres \
            -e DB_PORT=5432 \
            -e DB_NAME=sponsor_portal \
            -e DB_USER=postgres \
            -e DB_PASSWORD=postgres \
            -e DB_SSL=false \
            -e JWT_SECRET=test-jwt-secret-for-ci \
            ci bash -c "
              cd /workspace/src/apps/daily-diary/diary_functions
              dart test integration_test/
            "

      - name: Run diary_server integration tests
        if: steps.filter.outputs.relevant == 'true'
        working-directory: tools/dev-env
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T \
            -e DB_HOST=postgres \
            -e DB_PORT=5432 \
            -e DB_NAME=sponsor_portal \
            -e DB_USER=postgres \
            -e DB_PASSWORD=postgres \
            -e DB_SSL=false \
            -e JWT_SECRET=test-jwt-secret-for-ci \
            ci bash -c "
              cd /workspace/src/apps/daily-diary/diary_server
              dart test integration_test/
            "

      # ---------------------------------------------------------------
      # Coverage collection
      # ---------------------------------------------------------------
      - name: Run diary_functions tests with coverage
        if: steps.filter.outputs.relevant == 'true'
        working-directory: tools/dev-env
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T \
            -e DB_HOST=postgres \
            -e DB_PORT=5432 \
            -e DB_NAME=sponsor_portal \
            -e DB_USER=postgres \
            -e DB_PASSWORD=postgres \
            -e DB_SSL=false \
            -e JWT_SECRET=test-jwt-secret-for-ci \
            ci bash -c "
              cd /workspace/src/apps/daily-diary/diary_functions
              dart test --coverage=coverage test/ integration_test/
              dart pub global activate coverage
              dart pub global run coverage:format_coverage \
                --lcov \
                --in=coverage \
                --out=coverage/lcov.info \
                --report-on=lib \
                --packages=.dart_tool/package_config.json || true
            "

      - name: Run diary_server tests with coverage
        if: steps.filter.outputs.relevant == 'true'
        working-directory: tools/dev-env
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T \
            -e DB_HOST=postgres \
            -e DB_PORT=5432 \
            -e DB_NAME=sponsor_portal \
            -e DB_USER=postgres \
            -e DB_PASSWORD=postgres \
            -e DB_SSL=false \
            -e JWT_SECRET=test-jwt-secret-for-ci \
            ci bash -c "
              cd /workspace/src/apps/daily-diary/diary_server
              dart test --coverage=coverage test/ integration_test/
              dart pub global activate coverage
              dart pub global run coverage:format_coverage \
                --lcov \
                --in=coverage \
                --out=coverage/lcov.info \
                --report-on=lib \
                --packages=.dart_tool/package_config.json || true
            "

      # ---------------------------------------------------------------
      # Extract coverage from container for codecov upload
      # ---------------------------------------------------------------
      - name: Copy coverage from container
        if: steps.filter.outputs.relevant == 'true'
        working-directory: tools/dev-env
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T ci bash -c \
            "cat /workspace/src/apps/daily-diary/diary_server/coverage/lcov.info" \
            > $GITHUB_WORKSPACE/diary-server-lcov.info || true
          docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T ci bash -c \
            "cat /workspace/src/apps/daily-diary/diary_functions/coverage/lcov.info" \
            > $GITHUB_WORKSPACE/diary-functions-lcov.info || true

      - name: Upload diary_functions coverage to Codecov
        if: steps.filter.outputs.relevant == 'true'
        uses: codecov/codecov-action@v4
        with:
          files: diary-functions-lcov.info
          flags: diary-functions
          fail_ci_if_error: false

      - name: Upload diary_server coverage to Codecov
        if: steps.filter.outputs.relevant == 'true'
        uses: codecov/codecov-action@v4
        with:
          files: diary-server-lcov.info
          flags: diary-server
          fail_ci_if_error: false

      - name: Upload coverage reports as artifacts
        if: steps.filter.outputs.relevant == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            diary-functions-lcov.info
            diary-server-lcov.info
          retention-days: 30

      # ---------------------------------------------------------------
      # Cleanup
      # ---------------------------------------------------------------
      - name: Cleanup
        if: always()
        working-directory: tools/dev-env
        run: docker compose -f docker-compose.yml -f docker-compose.ci.yml --profile db down -v
