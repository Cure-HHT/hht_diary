# IMPLEMENTS REQUIREMENTS:
#   REQ-d00005: Sponsor Configuration Detection Implementation
#   REQ-p00008: User Account Management
#   REQ-o00081: Code Quality and Static Analysis (analyze job)
#   REQ-o00082: Automated Test Execution (unit-tests, integration-tests, coverage jobs)
#
# CI workflow for diary_server and diary_functions
# Runs static analysis, unit tests, integration tests (with PostgreSQL), and coverage

name: Diary Server CI

permissions:
  contents: read

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      relevant: ${{ steps.filter.outputs.relevant }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Check for relevant changes
        id: filter
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "relevant=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          CHANGED=$(git diff --name-only ${{ github.event.pull_request.base.sha || 'HEAD~1' }} ${{ github.sha }} | grep -E '^apps/daily-diary/|^database/|^\.github/workflows/diary-server-ci\.yml$' || true)
          if [ -n "$CHANGED" ]; then
            echo "relevant=true" >> $GITHUB_OUTPUT
          else
            echo "relevant=false" >> $GITHUB_OUTPUT
          fi

  ci:
    name: Diary Server CI
    runs-on: ubuntu-latest
    needs: changes
    timeout-minutes: 30

    services:
      postgres:
        image: postgres:17-alpine  # version pinned in .github/versions.env
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: sponsor_portal
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Skip - no relevant changes
        if: needs.changes.outputs.relevant != 'true'
        run: echo "No relevant changes detected â€” skipping"

      - uses: actions/checkout@v4
        if: needs.changes.outputs.relevant == 'true'

      - name: Load version pinning
        if: needs.changes.outputs.relevant == 'true'
        id: versions
        run: |
          source .github/versions.env
          echo "dart_version=${DART_VERSION}" >> $GITHUB_OUTPUT

      - uses: dart-lang/setup-dart@v1
        if: needs.changes.outputs.relevant == 'true'
        with:
          sdk: '${{ steps.versions.outputs.dart_version }}'

      - name: Install dependencies (diary_functions)
        if: needs.changes.outputs.relevant == 'true'
        working-directory: apps/daily-diary/diary_functions
        run: dart pub get

      - name: Install dependencies (diary_server)
        if: needs.changes.outputs.relevant == 'true'
        working-directory: apps/daily-diary/diary_server
        run: dart pub get

      - name: Analyze diary_functions
        if: needs.changes.outputs.relevant == 'true'
        working-directory: apps/daily-diary/diary_functions
        run: dart analyze --fatal-infos

      - name: Analyze diary_server
        if: needs.changes.outputs.relevant == 'true'
        working-directory: apps/daily-diary/diary_server
        run: dart analyze --fatal-infos

      - name: Check formatting
        if: needs.changes.outputs.relevant == 'true'
        run: |
          dart format --set-exit-if-changed apps/daily-diary/diary_functions
          dart format --set-exit-if-changed apps/daily-diary/diary_server

      - name: Wait for PostgreSQL
        if: needs.changes.outputs.relevant == 'true'
        run: |
          until pg_isready -h localhost -p 5432 -U postgres; do
            echo "Waiting for PostgreSQL..."
            sleep 2
          done

      - name: Apply database schema
        if: needs.changes.outputs.relevant == 'true'
        env:
          PGPASSWORD: postgres
        run: |
          psql -h localhost -U postgres -d sponsor_portal -f database/init.sql

      - name: Activate coverage tool
        if: needs.changes.outputs.relevant == 'true'
        run: dart pub global activate coverage

      - name: Run diary_functions tests with coverage
        if: needs.changes.outputs.relevant == 'true'
        working-directory: apps/daily-diary/diary_functions
        env:
          DB_HOST: localhost
          DB_PORT: '5432'
          DB_NAME: sponsor_portal
          DB_USER: postgres
          DB_PASSWORD: postgres
          DB_SSL: 'false'
          JWT_SECRET: test-jwt-secret-for-ci
        run: |
          dart test --coverage=coverage test/ integration_test/

      - name: Generate diary_functions coverage report
        if: needs.changes.outputs.relevant == 'true'
        working-directory: apps/daily-diary/diary_functions
        run: |
          dart pub global run coverage:format_coverage \
            --lcov \
            --in=coverage \
            --out=coverage/lcov.info \
            --report-on=lib \
            --packages=.dart_tool/package_config.json || true

      - name: Run diary_server tests with coverage
        if: needs.changes.outputs.relevant == 'true'
        working-directory: apps/daily-diary/diary_server
        env:
          DB_HOST: localhost
          DB_PORT: '5432'
          DB_NAME: sponsor_portal
          DB_USER: postgres
          DB_PASSWORD: postgres
          DB_SSL: 'false'
          JWT_SECRET: test-jwt-secret-for-ci
        run: |
          dart test --coverage=coverage test/ integration_test/

      - name: Generate diary_server coverage report
        if: needs.changes.outputs.relevant == 'true'
        working-directory: apps/daily-diary/diary_server
        run: |
          dart pub global run coverage:format_coverage \
            --lcov \
            --in=coverage \
            --out=coverage/lcov.info \
            --report-on=lib \
            --packages=.dart_tool/package_config.json || true

      - name: Upload diary_functions coverage to Codecov
        if: needs.changes.outputs.relevant == 'true'
        uses: codecov/codecov-action@v4
        with:
          files: apps/daily-diary/diary_functions/coverage/lcov.info
          flags: diary-functions
          fail_ci_if_error: false

      - name: Upload diary_server coverage to Codecov
        if: needs.changes.outputs.relevant == 'true'
        uses: codecov/codecov-action@v4
        with:
          files: apps/daily-diary/diary_server/coverage/lcov.info
          flags: diary-server
          fail_ci_if_error: false

      - name: Upload coverage reports as artifacts
        if: needs.changes.outputs.relevant == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            apps/daily-diary/diary_functions/coverage/lcov.info
            apps/daily-diary/diary_server/coverage/lcov.info
          retention-days: 30
