# IMPLEMENTS REQUIREMENTS:
#   REQ-d00030: CI/CD Environment Parity
#   REQ-d00031: Identity Platform Integration
#   REQ-d00032: Role-Based Access Control Implementation
#   REQ-p00024: Portal User Roles and Permissions
#   REQ-o00081: Code Quality and Static Analysis (analyze job)
#   REQ-o00082: Automated Test Execution (unit-tests, integration-tests, coverage jobs)
#
# CI workflow for sponsor-portal (portal_functions, portal_server, portal-ui)
# Runs unit tests, integration tests (with PostgreSQL + Firebase emulator), and coverage
# using CI container + Docker Compose PostgreSQL sidecar.

name: Sponsor Portal CI

permissions:
  contents: read
  packages: read

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  # Coverage threshold
  MIN_COVERAGE: 70

jobs:
  test:
    name: Sponsor Portal CI
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect relevant changes
        id: filter
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "relevant=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          CHANGED=$(git diff --name-only ${{ github.event.pull_request.base.sha || 'HEAD~1' }} ${{ github.sha }} | grep -E '^apps/sponsor-portal/|^database/|^\.github/workflows/sponsor-portal-ci\.yml$' || true)
          if [ -n "$CHANGED" ]; then
            echo "relevant=true" >> $GITHUB_OUTPUT
          else
            echo "relevant=false" >> $GITHUB_OUTPUT
          fi

      - name: Start CI container
        if: steps.filter.outputs.relevant == 'true'
        uses: ./.github/actions/start-ci-container
        with:
          profile: db
          ghcr-token: ${{ secrets.GITHUB_TOKEN }}

      # ---------------------------------------------------------------
      # Create sponsor_portal database
      # ---------------------------------------------------------------
      - name: Create sponsor_portal database
        if: steps.filter.outputs.relevant == 'true'
        working-directory: tools/dev-env
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T \
            -e PGPASSWORD=postgres \
            ci bash -c "psql -h postgres -U postgres -c 'CREATE DATABASE sponsor_portal;'" || true

      # ---------------------------------------------------------------
      # Install dependencies for all packages
      # ---------------------------------------------------------------
      - name: Install dependencies
        if: steps.filter.outputs.relevant == 'true'
        working-directory: tools/dev-env
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T ci bash -c "
            cd /workspace/src/apps/sponsor-portal/portal_functions && dart pub get
            cd /workspace/src/apps/sponsor-portal/portal_server && dart pub get
            cd /workspace/src/apps/sponsor-portal/portal-ui && flutter pub get
          "

      # ---------------------------------------------------------------
      # Static analysis + formatting
      # ---------------------------------------------------------------
      - name: Analyze portal_functions
        if: steps.filter.outputs.relevant == 'true'
        working-directory: tools/dev-env
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T ci bash -c "
            cd /workspace/src/apps/sponsor-portal/portal_functions
            dart analyze --fatal-infos
          "

      - name: Analyze portal_server
        if: steps.filter.outputs.relevant == 'true'
        working-directory: tools/dev-env
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T ci bash -c "
            cd /workspace/src/apps/sponsor-portal/portal_server
            dart analyze --fatal-infos
          "

      - name: Analyze portal-ui
        if: steps.filter.outputs.relevant == 'true'
        working-directory: tools/dev-env
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T ci bash -c "
            cd /workspace/src/apps/sponsor-portal/portal-ui
            flutter analyze
          "

      - name: Check formatting
        if: steps.filter.outputs.relevant == 'true'
        working-directory: tools/dev-env
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T ci bash -c "
            dart format --set-exit-if-changed /workspace/src/apps/sponsor-portal/portal_functions
            dart format --set-exit-if-changed /workspace/src/apps/sponsor-portal/portal_server
          "

      # ---------------------------------------------------------------
      # Unit tests
      # ---------------------------------------------------------------
      - name: Run portal_functions unit tests
        if: steps.filter.outputs.relevant == 'true'
        working-directory: tools/dev-env
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T ci bash -c "
            cd /workspace/src/apps/sponsor-portal/portal_functions
            dart test test/
          "

      - name: Run portal_server unit tests
        if: steps.filter.outputs.relevant == 'true'
        working-directory: tools/dev-env
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T ci bash -c "
            cd /workspace/src/apps/sponsor-portal/portal_server
            dart test test/
          "

      - name: Run portal-ui unit tests
        if: steps.filter.outputs.relevant == 'true'
        working-directory: tools/dev-env
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T ci bash -c "
            cd /workspace/src/apps/sponsor-portal/portal-ui
            flutter test
          "

      # ---------------------------------------------------------------
      # Schema deploy for integration tests
      # ---------------------------------------------------------------
      - name: Deploy database schema
        if: steps.filter.outputs.relevant == 'true'
        working-directory: tools/dev-env
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T \
            -e PGPASSWORD=postgres \
            ci bash -c "
              cd /workspace/src
              psql -h postgres -U postgres -d sponsor_portal --set ON_ERROR_STOP=1 -f database/init.sql
              psql -h postgres -U postgres -d sponsor_portal --set ON_ERROR_STOP=1 -f database/init_test.sql
            "

      # ---------------------------------------------------------------
      # Integration tests (Firebase emulator + PostgreSQL)
      # ---------------------------------------------------------------
      - name: Run portal_functions integration tests
        if: steps.filter.outputs.relevant == 'true'
        working-directory: tools/dev-env
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T ci bash -c "
            firebase emulators:start --only auth --project demo-sponsor-portal &
            sleep 5  # wait for emulator to start
            cd /workspace/src/apps/sponsor-portal/portal_functions
            DB_HOST=postgres DB_PORT=5432 DB_USER=postgres DB_PASSWORD=postgres DB_NAME=sponsor_portal \
            DB_SSL=false FIREBASE_AUTH_EMULATOR_HOST=localhost:9099 GCP_PROJECT_ID=demo-sponsor-portal \
            dart test integration_test/
          "

      - name: Run portal_server integration tests
        if: steps.filter.outputs.relevant == 'true'
        working-directory: tools/dev-env
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T ci bash -c "
            firebase emulators:start --only auth --project demo-sponsor-portal &
            sleep 5  # wait for emulator to start
            cd /workspace/src/apps/sponsor-portal/portal_server
            DB_HOST=postgres DB_PORT=5432 DB_USER=postgres DB_PASSWORD=postgres DB_NAME=sponsor_portal \
            DB_SSL=false FIREBASE_AUTH_EMULATOR_HOST=localhost:9099 GCP_PROJECT_ID=demo-sponsor-portal \
            dart test integration_test/
          "

      # ---------------------------------------------------------------
      # Coverage collection
      # ---------------------------------------------------------------
      - name: Run portal_functions tests with coverage
        if: steps.filter.outputs.relevant == 'true'
        working-directory: tools/dev-env
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T ci bash -c "
            firebase emulators:start --only auth --project demo-sponsor-portal &
            sleep 5  # wait for emulator to start
            cd /workspace/src/apps/sponsor-portal/portal_functions
            DB_HOST=postgres DB_PORT=5432 DB_USER=postgres DB_PASSWORD=postgres DB_NAME=sponsor_portal \
            DB_SSL=false FIREBASE_AUTH_EMULATOR_HOST=localhost:9099 GCP_PROJECT_ID=demo-sponsor-portal \
            dart test --coverage=coverage test/ integration_test/
            dart pub global activate coverage
            dart pub global run coverage:format_coverage \
              --lcov \
              --in=coverage \
              --out=coverage/lcov.info \
              --report-on=lib \
              --packages=.dart_tool/package_config.json || true
          "

      - name: Run portal_server tests with coverage
        if: steps.filter.outputs.relevant == 'true'
        working-directory: tools/dev-env
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T ci bash -c "
            firebase emulators:start --only auth --project demo-sponsor-portal &
            sleep 5  # wait for emulator to start
            cd /workspace/src/apps/sponsor-portal/portal_server
            DB_HOST=postgres DB_PORT=5432 DB_USER=postgres DB_PASSWORD=postgres DB_NAME=sponsor_portal \
            DB_SSL=false FIREBASE_AUTH_EMULATOR_HOST=localhost:9099 GCP_PROJECT_ID=demo-sponsor-portal \
            dart test --coverage=coverage test/ integration_test/
            dart pub global activate coverage
            dart pub global run coverage:format_coverage \
              --lcov \
              --in=coverage \
              --out=coverage/lcov.info \
              --report-on=lib \
              --packages=.dart_tool/package_config.json || true
          "

      - name: Run portal-ui tests with coverage
        if: steps.filter.outputs.relevant == 'true'
        working-directory: tools/dev-env
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T ci bash -c "
            cd /workspace/src/apps/sponsor-portal/portal-ui
            flutter test --coverage
          "

      # ---------------------------------------------------------------
      # Extract coverage from container for codecov upload
      # ---------------------------------------------------------------
      - name: Copy coverage from container
        if: steps.filter.outputs.relevant == 'true'
        working-directory: tools/dev-env
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T ci bash -c \
            "cat /workspace/src/apps/sponsor-portal/portal_functions/coverage/lcov.info" \
            > $GITHUB_WORKSPACE/portal-functions-lcov.info || true
          docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T ci bash -c \
            "cat /workspace/src/apps/sponsor-portal/portal_server/coverage/lcov.info" \
            > $GITHUB_WORKSPACE/portal-server-lcov.info || true
          docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T ci bash -c \
            "cat /workspace/src/apps/sponsor-portal/portal-ui/coverage/lcov.info" \
            > $GITHUB_WORKSPACE/portal-ui-lcov.info || true

      - name: Upload portal_functions coverage to Codecov
        if: steps.filter.outputs.relevant == 'true'
        uses: codecov/codecov-action@v4
        with:
          files: portal-functions-lcov.info
          flags: portal-functions
          fail_ci_if_error: false

      - name: Upload portal_server coverage to Codecov
        if: steps.filter.outputs.relevant == 'true'
        uses: codecov/codecov-action@v4
        with:
          files: portal-server-lcov.info
          flags: portal-server
          fail_ci_if_error: false

      - name: Upload portal-ui coverage to Codecov
        if: steps.filter.outputs.relevant == 'true'
        uses: codecov/codecov-action@v4
        with:
          files: portal-ui-lcov.info
          flags: portal-ui
          fail_ci_if_error: false

      - name: Upload coverage reports as artifacts
        if: steps.filter.outputs.relevant == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: sponsor-portal-coverage
          path: |
            portal-functions-lcov.info
            portal-server-lcov.info
            portal-ui-lcov.info
          retention-days: 30

      # ---------------------------------------------------------------
      # Cleanup
      # ---------------------------------------------------------------
      - name: Cleanup
        if: always()
        working-directory: tools/dev-env
        run: docker compose -f docker-compose.yml -f docker-compose.ci.yml --profile db down -v
