# IMPLEMENTS REQUIREMENTS:
#   REQ-d00028: Role-Based Environment Separation
#   REQ-d00030: CI/CD Environment Parity
#   REQ-d00031: Automated QA Testing
#   REQ-d00033: FDA Validation Documentation
#   REQ-p01018: Security Audit and Compliance (automated vulnerability scanning)
#   REQ-o00083: QA Promotion Gate (ci-tests job)
#   REQ-o00080: Secret and Vulnerability Scanning (security-scan job)
#   REQ-o00081: Code Quality and Static Analysis (flutter analyze, sql linting in ci-tests)
#
# Clinical Diary QA Automation Workflow
# Consolidated into 2 jobs:
#   1. ci-tests: Flutter tests, static analysis, SQL linting (all via CI container)
#   2. security-scan: Trivy scans (GHA actions scanning the container from outside)

name: QA Automation

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - 'feature/**'
      - 'release/**'
    paths:
      - 'apps/daily-diary/**'
      - 'tools/dev-env/**'
      - 'database/**'
      - '.github/workflows/qa-automation.yml'
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run (all, unit, integration, e2e)'
        required: false
        default: 'all'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # COHERENT CACHING: Use BuildKit with GHCR registry cache
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  # ===========================================================================
  # Job 1: CI Tests & Analysis
  # Runs Flutter tests, Flutter analyze, and SQL linting inside the CI container.
  # Replaces former qa-tests, flutter-dart-security, and sql-linting jobs.
  # ===========================================================================
  ci-tests:
    name: CI Tests & Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      contents: read
      pull-requests: write
      checks: write
      packages: read
      actions: read  # Required for gh run watch in start-ci-container

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git diff and change detection

      - name: Check if QA tests should run
        id: check-qa-needed
        run: |
          echo "::group::Checking if QA tests are needed for this PR"

          # Check for skip label
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            LABELS="${{ join(github.event.pull_request.labels.*.name, ' ') }}"
            if echo "$LABELS" | grep -q "skip-qa"; then
              echo "qa_needed=false" >> $GITHUB_OUTPUT
              echo "PR has 'skip-qa' label - skipping QA tests"
              echo "::endgroup::"
              exit 0
            fi
          fi

          # Get list of changed files
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }})
          else
            # For workflow_dispatch, always run
            echo "qa_needed=true" >> $GITHUB_OUTPUT
            echo "Manual trigger - will run QA tests"
            echo "::endgroup::"
            exit 0
          fi

          # Patterns that require QA tests
          QA_PATTERNS=(
            'dev-env'                # Dev environment scripts
            'apps\/daily-diary\/clinical_diary'    # Main app code
            'packages\/'             # Shared packages
            'database\/'             # Database schema / migrations
            '^\.github\/workflows\/qa-automation\.yml$'  # This workflow itself
          )

          # Check if any changed file matches QA patterns
          for pattern in "${QA_PATTERNS[@]}"; do
            if echo "$CHANGED_FILES" | grep -qE "$pattern"; then
              QA_NEEDED=true
              echo "Found changes matching: $pattern"
              break
            fi
          done

          if [ "$QA_NEEDED" = "true" ]; then
            echo "qa_needed=true" >> $GITHUB_OUTPUT
            echo "QA tests are needed for this PR"
          else
            echo "qa_needed=false" >> $GITHUB_OUTPUT
            echo "No QA-relevant changes detected - skipping tests"
            echo ""
            echo "Changed files:"
            echo "$CHANGED_FILES" | sed 's/^/  - /'
            echo ""
            echo "To force QA tests, add the 'run-qa' label to this PR"
          fi

          echo "::endgroup::"

      - name: Skip QA tests (no relevant changes)
        if: steps.check-qa-needed.outputs.qa_needed == 'false'
        run: |
          echo "::notice::Skipping QA tests - no app/test code changes detected"
          echo "## QA Tests Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No QA-relevant changes detected in this PR." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**QA tests run when changes affect:**" >> $GITHUB_STEP_SUMMARY
          echo "- Flutter/Dart code (packages/, apps/, lib/)" >> $GITHUB_STEP_SUMMARY
          echo "- Test files (test/, tests/, e2e/)" >> $GITHUB_STEP_SUMMARY
          echo "- Database schema (database/)" >> $GITHUB_STEP_SUMMARY
          echo "- Dev environment (tools/dev-env/, Docker files)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To force QA tests, add the 'run-qa' label to this PR" >> $GITHUB_STEP_SUMMARY

      # -----------------------------------------------------------------
      # Start CI container via reusable composite action
      # Handles: GHCR login, Docker change detection, pull-or-build,
      #          compose up, health check
      # -----------------------------------------------------------------
      - name: Start CI container
        if: steps.check-qa-needed.outputs.qa_needed == 'true'
        uses: ./.github/actions/start-ci-container
        with:
          ghcr-token: ${{ secrets.GITHUB_TOKEN }}

      # -----------------------------------------------------------------
      # Flutter unit tests (from former qa-tests job)
      # -----------------------------------------------------------------
      - name: Run Flutter unit tests
        if: steps.check-qa-needed.outputs.qa_needed == 'true'
        id: flutter-tests
        working-directory: tools/dev-env
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T ci bash -c "
            cd /workspace/src/apps/daily-diary/clinical_diary 2>/dev/null || {
              echo 'No Flutter project found, skipping Flutter tests'
              exit 0
            }
            if [ -f pubspec.yaml ]; then
              flutter pub get
              mkdir -p /workspace/reports
              flutter test --coverage --reporter json > /workspace/reports/flutter-test-results.json 2>&1 || true
              flutter test --coverage
            fi
          "

      # -----------------------------------------------------------------
      # Flutter static analysis (from former flutter-dart-security job)
      # Runs inside CI container where Flutter is pre-installed
      # -----------------------------------------------------------------
      - name: Flutter analyze on all packages
        if: steps.check-qa-needed.outputs.qa_needed == 'true'
        id: flutter-analyze
        continue-on-error: true
        working-directory: tools/dev-env
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T ci bash -c "
            cd /workspace/src
            ANALYSIS_FAILED=false

            # Analyze root project
            if [ -f pubspec.yaml ]; then
              echo '--- Analyzing root project ---'
              flutter pub get
              if ! flutter analyze --no-fatal-infos --no-fatal-warnings; then
                ANALYSIS_FAILED=true
              fi
            fi

            # Analyze packages
            if [ -d packages ]; then
              for pkg in packages/*/; do
                if [ -f \"\${pkg}pubspec.yaml\" ]; then
                  PKG_NAME=\$(basename \"\$pkg\")
                  echo \"--- Analyzing package: \$PKG_NAME ---\"
                  (cd \"\$pkg\" && flutter pub get && flutter analyze --no-fatal-infos --no-fatal-warnings) || ANALYSIS_FAILED=true
                fi
              done
            fi

            # Analyze apps with pubspec.yaml
            if [ -d apps ]; then
              for app_dir in apps/daily-diary/clinical_diary; do
                if [ -f \"\${app_dir}/pubspec.yaml\" ]; then
                  echo \"--- Analyzing app: \$app_dir ---\"
                  (cd \"\$app_dir\" && flutter pub get && flutter analyze --no-fatal-infos --no-fatal-warnings) || ANALYSIS_FAILED=true
                fi
              done
            fi

            if [ \"\$ANALYSIS_FAILED\" = 'true' ]; then
              echo 'Flutter analysis found issues'
              exit 1
            fi
          "

      - name: Check for outdated dependencies
        if: steps.check-qa-needed.outputs.qa_needed == 'true'
        continue-on-error: true
        working-directory: tools/dev-env
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T ci bash -c "
            cd /workspace/src/apps/daily-diary/clinical_diary
            if [ -f pubspec.yaml ]; then
              flutter pub outdated || true
            fi
          "

      # -----------------------------------------------------------------
      # SQL migration linting (from former sql-linting job)
      # Squawk is pre-installed in the CI container
      # -----------------------------------------------------------------
      - name: SQL migration linting
        if: steps.check-qa-needed.outputs.qa_needed == 'true'
        continue-on-error: true
        working-directory: tools/dev-env
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T ci bash -c "
            cd /workspace/src
            CHANGED_SQL=\$(git diff --name-only --diff-filter=ACMR origin/main...HEAD | grep '\.sql$' || true)
            if [ -n \"\$CHANGED_SQL\" ]; then
              echo 'Linting changed SQL files...'
              echo \"\$CHANGED_SQL\" | while read f; do
                if [ -f \"\$f\" ]; then
                  echo \"Checking: \$f\"
                  squawk \"\$f\" || true
                fi
              done
            else
              echo 'No SQL files changed'
            fi
          "

      # -----------------------------------------------------------------
      # Copy artifacts out of container
      # -----------------------------------------------------------------
      - name: Copy artifacts from container
        if: always() && steps.check-qa-needed.outputs.qa_needed == 'true'
        working-directory: tools/dev-env
        continue-on-error: true
        run: |
          mkdir -p $GITHUB_WORKSPACE/qa-reports
          docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T ci bash -c \
            "cat /workspace/reports/flutter-test-results.json 2>/dev/null" \
            > $GITHUB_WORKSPACE/qa-reports/flutter-test-results.json || true
          docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T ci bash -c \
            "cat /workspace/src/apps/daily-diary/clinical_diary/coverage/lcov.info 2>/dev/null" \
            > $GITHUB_WORKSPACE/qa-reports/lcov.info || true

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: qa-reports-${{ github.sha }}
          path: |
            qa-reports/
          retention-days: 30
        continue-on-error: true

      # -----------------------------------------------------------------
      # PR comment with results
      # -----------------------------------------------------------------
      - name: Comment PR with test results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let comment = '## QA Automation Results\n\n';

            // Read test summary if available
            if (fs.existsSync('qa-reports/test-summary.md')) {
              const summary = fs.readFileSync('qa-reports/test-summary.md', 'utf8');
              comment += summary + '\n\n';
            }

            // Add artifact links
            comment += '### Detailed Reports\n\n';
            comment += `- [Test Reports Artifact](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n`;
            comment += `- Commit: \`${{ github.sha }}\`\n`;
            comment += `- Workflow: [View Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n\n`;

            // Add timestamp
            comment += `*Generated at ${new Date().toISOString()}*\n`;

            // Post comment
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      # -----------------------------------------------------------------
      # Cleanup (always runs)
      # -----------------------------------------------------------------
      - name: Cleanup
        if: always()
        working-directory: tools/dev-env
        run: docker compose -f docker-compose.yml -f docker-compose.ci.yml down -v

      - name: Fail workflow if tests failed
        if: steps.check-qa-needed.outputs.qa_needed == 'true' && steps.flutter-tests.outcome == 'failure'
        run: exit 1

  # ===========================================================================
  # Job 2: Security & Compliance Scan (Trivy)
  # Runs as GHA actions OUTSIDE the container â€” scans the image from the host.
  # ===========================================================================
  security-scan:
    name: Security & Compliance Scan
    runs-on: ubuntu-latest
    needs: ci-tests  # Wait for ci-tests to build and push images to GHCR
    # IMPLEMENTS REQUIREMENTS:
    #   REQ-p01018: Security Audit and Compliance (automated vulnerability scanning)
    # Enabled: Using Trivy which works with private repos without paid GitHub license
    # Scans: Filesystem dependencies, IaC configs, Container images

    permissions:
      contents: read
      security-events: write  # Required to upload SARIF results
      actions: read
      packages: read  # Required to pull images from GHCR

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner (filesystem)
        uses: aquasecurity/trivy-action@0.34.0  # version pinned in .github/versions.env (TRIVY_VERSION)
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-fs-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'  # Don't fail on filesystem issues
        env:
          TRIVY_QUIET: true  # Suppress INFO logs, keep errors and results

      - name: Run Trivy IaC scanner (Terraform, Docker, K8s)
        uses: aquasecurity/trivy-action@0.34.0  # version pinned in .github/versions.env (TRIVY_VERSION)
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-iac-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'  # Don't fail on IaC issues
          skip-dirs: 'node_modules,vendor,.git'
        env:
          TRIVY_QUIET: true  # Suppress INFO logs, keep errors and results

      - name: Check for Docker images to scan
        id: check-docker
        run: |
          if [ -f "tools/dev-env/docker/ci.Dockerfile" ] || find . -name "Dockerfile" -o -name "*.dockerfile" | grep -q .; then
            echo "has_docker=true" >> $GITHUB_OUTPUT
            echo "Dockerfile(s) detected - will scan container images"
          else
            echo "has_docker=false" >> $GITHUB_OUTPUT
            echo "No Dockerfiles found - skipping container scan"
          fi

      - name: Set lowercase repo owner
        id: repo-owner
        run: echo "owner=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Log in to GitHub Container Registry
        if: steps.check-docker.outputs.has_docker == 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Trivy container scanner (CI image from GHCR)
        if: steps.check-docker.outputs.has_docker == 'true'
        uses: aquasecurity/trivy-action@0.34.0  # version pinned in .github/versions.env (TRIVY_VERSION)
        with:
          scan-type: 'image'
          image-ref: 'ghcr.io/${{ steps.repo-owner.outputs.owner }}/clinical-diary-ci:latest'
          format: 'sarif'
          output: 'trivy-container-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'
        env:
          TRIVY_QUIET: true

      - name: Upload Trivy filesystem results to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: 'trivy-fs-results.sarif'
          category: 'trivy-filesystem'
        continue-on-error: true

      - name: Upload Trivy IaC results to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: 'trivy-iac-results.sarif'
          category: 'trivy-iac'
        continue-on-error: true

      - name: Upload Trivy container results to GitHub Security
        if: always() && steps.check-docker.outputs.has_docker == 'true'
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: 'trivy-container-results.sarif'
          category: 'trivy-container'
        continue-on-error: true

      - name: Generate comprehensive vulnerability report
        if: always()
        run: |
          echo "## Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Trivy Multi-Layer Security Scan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Filesystem scan
          if [ -f trivy-fs-results.sarif ]; then
            echo "**Filesystem Dependencies**: Scanned for vulnerable packages" >> $GITHUB_STEP_SUMMARY
          fi

          # IaC scan
          if [ -f trivy-iac-results.sarif ]; then
            echo "**Infrastructure as Code**: Scanned Dockerfiles, Terraform, K8s configs" >> $GITHUB_STEP_SUMMARY
          fi

          # Container scan
          if [ -f trivy-container-results.sarif ]; then
            echo "**Container Images**: Scanned CI development image" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Action**: Review detailed findings in the Security > Code scanning tab" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Scope**:" >> $GITHUB_STEP_SUMMARY
          echo "- Dependencies (npm, pub, pip packages)" >> $GITHUB_STEP_SUMMARY
          echo "- IaC misconfigurations (Docker, Terraform, K8s)" >> $GITHUB_STEP_SUMMARY
          echo "- Container vulnerabilities (OS packages, base images)" >> $GITHUB_STEP_SUMMARY

      - name: Upload all scan results as artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-scan-results-${{ github.sha }}
          path: |
            trivy-*.sarif
          retention-days: 30
        continue-on-error: true
