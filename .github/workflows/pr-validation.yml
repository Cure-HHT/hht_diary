# IMPLEMENTS REQUIREMENTS:
#   REQ-d00014: Requirement Validation Tooling
#   REQ-d00030: CI/CD Environment Parity
#   REQ-o00052: CI/CD Pipeline for Requirement Traceability
#   REQ-d00018: Git Hook Implementation
#   REQ-o00017: Version Control Workflow (commit message validation)
#   REQ-o00078: Change-Appropriate CI Validation (change detection, conditional checks)
#   REQ-o00079: Commit and PR Traceability Enforcement (PR title, commit messages, post-merge)
#   REQ-o00080: Secret and Vulnerability Scanning (gitleaks, Trivy)
#   REQ-o00081: Code Quality and Static Analysis (code headers, migration headers, doc linting)
#   REQ-p01018: Security Audit and Compliance (Trivy SARIF upload)

name: PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]
  push:
    branches:
      - main
      - develop

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  checks: write
  security-events: write
  packages: read
  actions: read  # Required for gh run watch in start-ci-container

jobs:
  # ===========================================================================
  # Security scan â€” Trivy filesystem & IaC scanning with SARIF upload
  # Runs on every PR and push to main/develop so GitHub Code Scanning always
  # has results, unblocking the repository ruleset requirement.
  # IMPLEMENTS REQUIREMENTS:
  #   REQ-p01018: Security Audit and Compliance (automated vulnerability scanning)
  #   REQ-o00080: Secret and Vulnerability Scanning (Trivy multi-layer scanning)
  # ===========================================================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15

    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner (filesystem)
        uses: aquasecurity/trivy-action@0.34.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-fs-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'
        env:
          TRIVY_QUIET: true

      - name: Run Trivy IaC scanner (Terraform, Docker, K8s)
        uses: aquasecurity/trivy-action@0.34.0
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-iac-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'
          skip-dirs: 'node_modules,vendor,.git'
        env:
          TRIVY_QUIET: true

      - name: Upload Trivy filesystem results to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: 'trivy-fs-results.sarif'
          category: 'trivy-filesystem'
        continue-on-error: true

      - name: Upload Trivy IaC results to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: 'trivy-iac-results.sarif'
          category: 'trivy-iac'
        continue-on-error: true


  # ===========================================================================
  # Single fast-fail validation job for pull requests
  # Replaces 10 parallel jobs with one sequential script (CUR-957)
  # ===========================================================================
  validate:
    name: PR Validation
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for commit traversal and gitleaks

      - name: Start CI container
        uses: ./.github/actions/start-ci-container
        with:
          ghcr-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Run validation
        working-directory: tools/dev-env
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T \
            -e PR_TITLE="${{ github.event.pull_request.title }}" \
            -e PR_BODY="${{ github.event.pull_request.body }}" \
            -e PR_NUMBER="${{ github.event.pull_request.number }}" \
            -e PR_URL="${{ github.event.pull_request.html_url }}" \
            -e BASE_SHA="${{ github.event.pull_request.base.sha }}" \
            -e HEAD_SHA="${{ github.event.pull_request.head.sha }}" \
            -e BASE_REF="${{ github.base_ref }}" \
            -e EVENT_NAME="${{ github.event_name }}" \
            -e GITHUB_ENV="/workspace/src/.ci-github-env" \
            ci bash -c "cd /workspace/src && .github/scripts/validate-pr.sh"

      - name: Import GITHUB_ENV from container
        run: |
          if [ -f .ci-github-env ]; then
            cat .ci-github-env >> "$GITHUB_ENV"
            rm -f .ci-github-env || true
          fi

      - name: Upload traceability artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: build-reports-${{ github.sha }}
          path: build-reports/
          retention-days: 90
          if-no-files-found: ignore  # Not all PRs generate traceability reports

      - name: Comment on PR with results
        if: success() && env.SPEC_CHANGED == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let comment = '## Requirements Validation Passed\n\n';
            comment += 'All requirements have been validated successfully.\n\n';

            try {
              const matrix = fs.readFileSync('build-reports/combined/traceability/traceability_matrix.md', 'utf8');
              const lines = matrix.split('\n');

              const summaryStart = lines.findIndex(l => l.includes('## Summary'));
              if (summaryStart >= 0) {
                const summaryLines = lines.slice(summaryStart, summaryStart + 20);
                comment += '### Combined Traceability Summary\n\n';
                comment += summaryLines.join('\n');
              } else {
                comment += '### Traceability Matrix Generated\n\n';
                comment += 'See artifacts for full traceability details.\n';
              }
            } catch (err) {
              console.error('Traceability matrix warning:', err);
              comment += 'Could not read traceability matrix summary.\n';
            }

            comment += '\n\n[View full traceability matrix in artifacts](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Cleanup
        if: always()
        working-directory: tools/dev-env
        run: docker compose -f docker-compose.yml -f docker-compose.ci.yml down -v

  # ===========================================================================
  # Post-merge validation: Check squash merge commits on main/develop
  # Creates a Linear ticket if the merge commit is missing required references
  # Implements: REQ-o00079-C (post-merge safety net)
  # ===========================================================================
  post-merge:
    name: Post-Merge Validation
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Validate merge commit message
        id: validate
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
          LINEAR_TEAM_ID: ${{ secrets.LINEAR_TEAM_ID }}
        run: |
          set -euo pipefail

          COMMIT_SHA="${{ github.sha }}"
          COMMIT_MSG=$(git log -1 --format='%B' "$COMMIT_SHA")
          COMMIT_SUBJECT=$(git log -1 --format='%s' "$COMMIT_SHA")
          COMMIT_AUTHOR=$(git log -1 --format='%an' "$COMMIT_SHA")
          BRANCH="${{ github.ref_name }}"

          echo "Checking merge commit: ${COMMIT_SHA:0:7}"
          echo "Subject: $COMMIT_SUBJECT"
          echo ""

          HAS_CUR=false
          if echo "$COMMIT_MSG" | grep -qE '\[?CUR-[0-9]+\]?'; then
            HAS_CUR=true
          fi

          # REQ is advisory only (per CUR-677)
          HAS_REQ=false
          if echo "$COMMIT_MSG" | grep -qE '(REQ|EQ-CAL)-[pdo][0-9]{5}'; then
            HAS_REQ=true
          fi

          ERRORS=""
          if [ "$HAS_CUR" = "false" ]; then
            ERRORS="missing CUR-XXX"
          fi
          if [ "$HAS_REQ" = "false" ]; then
            if [ -n "$ERRORS" ]; then
              ERRORS="$ERRORS, missing REQ-XXX (advisory)"
            else
              ERRORS="missing REQ-XXX (advisory)"
            fi
          fi

          if [ "$HAS_CUR" = "false" ]; then
            echo "Merge commit is missing required CUR reference: $ERRORS"
            echo "has_errors=true" >> $GITHUB_OUTPUT
            echo "errors=$ERRORS" >> $GITHUB_OUTPUT
            echo "commit_sha=${COMMIT_SHA:0:7}" >> $GITHUB_OUTPUT
            echo "commit_subject=$COMMIT_SUBJECT" >> $GITHUB_OUTPUT
            echo "commit_author=$COMMIT_AUTHOR" >> $GITHUB_OUTPUT
            echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          else
            echo "Merge commit has valid CUR-XXX reference"
            if [ "$HAS_REQ" = "false" ]; then
              echo "::warning::Merge commit is missing REQ-XXX reference (advisory only)"
            fi
            echo "has_errors=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Linear ticket for non-compliant merge
        if: steps.validate.outputs.has_errors == 'true'
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
          LINEAR_TEAM_ID: ${{ secrets.LINEAR_TEAM_ID }}
        run: |
          set -euo pipefail

          if [ -z "${LINEAR_API_KEY:-}" ] || [ -z "${LINEAR_TEAM_ID:-}" ]; then
            echo "::warning::LINEAR_API_KEY or LINEAR_TEAM_ID not configured. Skipping ticket creation."
            exit 0
          fi

          COMMIT_SHA="${{ steps.validate.outputs.commit_sha }}"
          COMMIT_SUBJECT="${{ steps.validate.outputs.commit_subject }}"
          COMMIT_AUTHOR="${{ steps.validate.outputs.commit_author }}"
          ERRORS="${{ steps.validate.outputs.errors }}"
          BRANCH="${{ steps.validate.outputs.branch }}"
          COMMIT_URL="${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"

          TITLE="[Compliance] Merge commit missing references: $COMMIT_SHA"

          DESCRIPTION="## Non-Compliant Merge Commit Detected

          A merge commit to \`$BRANCH\` is missing required traceability references.

          ### Details
          - **Commit**: [$COMMIT_SHA]($COMMIT_URL)
          - **Subject**: $COMMIT_SUBJECT
          - **Author**: $COMMIT_AUTHOR
          - **Branch**: $BRANCH
          - **Issues**: $ERRORS

          ### Required Format
          Merge commits should include:
          - \`[CUR-XXX]\` - Linear ticket reference (required)
          - \`Implements: REQ-{type}{number}\` - Requirement reference (advisory)

          ### Action Required
          1. Review the merge commit
          2. Ensure future PRs have proper references before merging

          ---
          *Auto-generated by PR Validation workflow*"

          RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: $LINEAR_API_KEY" \
            --data "{
              \"query\": \"mutation { issueCreate(input: { teamId: \\\"$LINEAR_TEAM_ID\\\", title: \\\"$TITLE\\\", description: $(echo "$DESCRIPTION" | jq -Rs .), labelIds: [] }) { success issue { id identifier url } } }\"
            }" \
            https://api.linear.app/graphql)

          if echo "$RESPONSE" | jq -e '.data.issueCreate.success' > /dev/null 2>&1; then
            TICKET_ID=$(echo "$RESPONSE" | jq -r '.data.issueCreate.issue.identifier')
            TICKET_URL=$(echo "$RESPONSE" | jq -r '.data.issueCreate.issue.url')
            echo "Created Linear ticket: $TICKET_ID"
            echo "  URL: $TICKET_URL"
            echo "::notice::Created compliance ticket $TICKET_ID for non-compliant merge commit"
          else
            echo "::warning::Failed to create Linear ticket"
            echo "Response: $RESPONSE"
          fi
