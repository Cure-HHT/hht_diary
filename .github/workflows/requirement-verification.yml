name: Requirement Verification

on:
  push:
    paths:
      - 'spec/**/*.md'
  pull_request:
    paths:
      - 'spec/**/*.md'

jobs:
  verify-requirements:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git operations

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Load version configuration
        id: versions
        run: |
          source .github/versions.env
          echo "elspais_version=${ELSPAIS_VERSION}" >> $GITHUB_OUTPUT

      - name: Install elspais
        run: |
          python3 -m pip install --upgrade pip
          ELSPAIS_VERSION="${{ steps.versions.outputs.elspais_version }}"
          echo "Installing elspais v${ELSPAIS_VERSION}..."
          pip install elspais==${ELSPAIS_VERSION}
          elspais --version

      - name: Validate requirement format and IDs
        run: |
          echo "Validating requirements..."
          elspais validate
          echo "Requirement validation passed"

      - name: Validate INDEX.md
        run: |
          echo "Validating INDEX.md..."
          elspais index validate
          echo "INDEX.md validation passed"

      - name: Generate traceability matrix
        run: |
          echo "Generating traceability matrix..."
          mkdir -p build-reports/combined/traceability
          elspais trace --format both --output build-reports/combined/traceability/traceability_matrix
          echo "Traceability matrix generated"

      - name: Upload build reports as artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: verification-report-${{ github.sha }}
          path: build-reports/
          retention-days: 90

      - name: Summary
        if: always()
        run: |
          echo "## Requirement Verification Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Requirement format and ID validation: ${{ steps.validate.outcome || 'passed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- INDEX.md validation: passed" >> $GITHUB_STEP_SUMMARY
          echo "- Traceability matrix: generated" >> $GITHUB_STEP_SUMMARY
