---
# IMPLEMENTS REQUIREMENTS:
#   REQ-d00027: Containerized Development Environments
#   REQ-d00030: CI/CD Integration
#   REQ-d00033: FDA Validation Documentation
#   REQ-d00035: Security and Compliance
#
# Clinical Diary Docker Image Build & Publish
# Builds, signs, tags and pushes diary-server image to GitHub Container Registry

name: Build & Publish Diary Images

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build and push (example: v1.2.3, 1.2.3, 1.2.3-beta.1)'
        required: true
        default: ''
      create_tag:
        description: 'If true, create/push the annotated git tag back to the repo (requires push permission).'
        required: false
        default: 'false'
env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: cure-hht/diary-server
  # IMAGE_PREFIX: ${{ github.repository_owner }}/diary-server

permissions:
  contents: read
  packages: write
  id-token: write  # For Cosign signing

jobs:
  build-base:
    name: Build Base Image
    runs-on: ubuntu-latest

    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
      image_digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          # Use docker driver for PR builds to enable docker load/image sharing between jobs
          driver: docker
          # Use docker-container driver (default) for main builds to support provenance/SBOM
          # driver: ${{ github.event_name == 'pull_request' && 'docker' || 'docker-container' }}

      - name: Log in to GitHub Container Registry
        # if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine tag and validate semver
        id: parse
        run: |
          set -euo pipefail

          # Source tag:
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            RAW_TAG="${{ github.event.inputs.version }}"
          else
            RAW_TAG="${GITHUB_REF#refs/tags/}"
          fi

          # Normalize (strip optional leading v)
          VERSION="${RAW_TAG#v}"

          # semver regex that accepts prerelease and build metadata per semver.org
          SEMVER_RE='^(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)(?:-([0-9A-Za-z-]+(?:\.[0-9A-Za-z-]+)*))?(?:\+([0-9A-Za-z-]+(?:\.[0-9A-Za-z-]+)*))?$'

          if ! echo "$VERSION" | grep -Eq "$SEMVER_RE"; then
            echo "Invalid semantic version: '$RAW_TAG'. Expected MAJOR.MINOR.PATCH with optional -prerelease and +build."
            exit 1
          fi

          CORE="$(echo "$VERSION" | sed -e 's/-.*$//' -e 's/\+.*$//')"
          MAJOR="${CORE%%.*}"
          MAJOR_MINOR="$(echo "$CORE" | awk -F. '{print $1"."$2}')"

          # is there prerelease or build metadata?
          if echo "$VERSION" | grep -Eq '[-+]'; then
            IS_RELEASE=false
          else
            IS_RELEASE=true
          fi
          IS_RELEASE=false  #TODO TEMPORARILY DISABLE RELEASE TAGS FOR NOW

          # sanitize for docker tags: convert '+' to '-' and lowercase
          DOCKER_VER="$(echo "$VERSION" | sed 's/+/-/g' | tr '[:upper:]' '[:lower:]')"

          SHORT_SHA="${GITHUB_SHA::7}"
          TAG_FULL="v${VERSION}"   # canonical tag with leading v

          echo "::notice::Resolved version='$VERSION' (canonical tag='$TAG_FULL'), docker_tag='$DOCKER_VER', is_release=$IS_RELEASE"

          # Build the newline-separated tags list for build-push-action
          # Always push full semver and short sha; for releases also add MAJOR_MINOR, MAJOR and latest
          TAGS="${REGISTRY}/${IMAGE_PREFIX}:${MAJOR_MINOR}, ${REGISTRY}/${IMAGE_PREFIX}:${SHORT_SHA}"
          if [ "$IS_RELEASE" = "true" ]; then
            TAGS="${TAGS}, ${REGISTRY}/${IMAGE_PREFIX}:${MAJOR_MINOR}, ${REGISTRY}/${IMAGE_PREFIX}:${MAJOR}, ${REGISTRY}/${IMAGE_PREFIX}:latest"
          fi

          # Export outputs (use GITHUB_OUTPUT format)
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "docker_ver=${DOCKER_VER}" >> "$GITHUB_OUTPUT"
          echo "core=${CORE}" >> "$GITHUB_OUTPUT"
          echo "major=${MAJOR}" >> "$GITHUB_OUTPUT"
          echo "major_minor=${MAJOR_MINOR}" >> "$GITHUB_OUTPUT"
          echo "is_release=${IS_RELEASE}" >> "$GITHUB_OUTPUT"
          echo "short_sha=${SHORT_SHA}" >> "$GITHUB_OUTPUT"
          echo "tag_full=${TAG_FULL}" >> "$GITHUB_OUTPUT"
          # tags is multiline output
          echo "tags<<EOF" >> "$GITHUB_OUTPUT"
          printf "%s\n" "$TAGS" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

          # ECHO outputs
          echo "version=${VERSION}"
          echo "docker_ver=${DOCKER_VER}"
          echo "core=${CORE}"
          echo "major=${MAJOR}"
          echo "major_minor=${MAJOR_MINOR}"
          echo "is_release=${IS_RELEASE}"
          echo "short_sha=${SHORT_SHA}"
          echo "tag_full=${TAG_FULL}"
          # tags is multiline output
          echo "tags<<EOF"
          printf "%s\n" "$TAGS"
          echo "EOF"

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-base
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix=sha-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push base image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: tools/dev-env/docker
          file: tools/dev-env/docker/base.Dockerfile
          # IMPORTANT: platforms linux/amd64 is required for Cloud Run compatibility
          platforms: linux/amd64
          push: true
          # push: ${{ github.ref == 'refs/heads/main' || github.event.inputs.push_to_registry == 'true' }}
          tags: ${{ steps.parse.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # COHERENT CACHING: GHCR only (no GHA cache)
          # Images in GHCR serve as cache - pull latest before build
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-base:latest
          cache-to: type=inline
          provenance: false
          sbom: false
          # provenance: ${{ github.event_name != 'pull_request' }}
          # sbom: ${{ github.event_name != 'pull_request' }}

      - name: Tag image for local use
        # if: github.event_name == 'pull_request'
        run: |
          # Extract first tag from metadata action output
          FIRST_TAG=$(echo '${{ steps.meta.outputs.tags }}' | head -n1)
          docker tag "$FIRST_TAG" diary-server-base:latest

      - name: Export local image for downstream jobs
        # if: github.event_name == 'pull_request'
        run: docker save -o /tmp/base-image.tar diary-server-base:latest

      - name: Upload base image artifact
        # if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: base-image
          path: /tmp/base-image.tar
          retention-days: 1
# env:
#   REGISTRY: ghcr.io
#   # IMAGE: ${{ github.repository }}
#   IMAGE: diary-server
#   IMAGE_PREFIX: ${{ github.repository_owner }}/${IMAGE}

# permissions:
#   contents: write    # needed if creating/pushing tags
#   packages: write
#   id-token: write    # For Cosign signing

# jobs:
#   build-diary-server-image:
#     name: Build Image
#     runs-on: ubuntu-latest

#     outputs:
#       image_tag: ${{ steps.meta.outputs.tags }}
#       image_digest: ${{ steps.build.outputs.digest }}

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4
#         with:
#           fetch-depth: 0

#       - name: Set up Docker Buildx
#         uses: docker/setup-buildx-action@v3
#         with:
#           # Use docker driver for PR builds to enable docker load/image sharing between jobs
#           # Use docker-container driver (default) for main builds to support provenance/SBOM
#           driver: ${{ github.event_name == 'pull_request' && 'docker' || 'docker-container' }}


#       - name: Set up QEMU
#         uses: docker/setup-qemu-action@v3

#       # - name: Extract version parts from tag
#       #   id: parse
#       #   run: |
#       #     # GITHUB_REF is like refs/tags/v1.2.3
#       #     TAG=${GITHUB_REF#refs/tags/}
#       #     VERSION=${TAG#v}                     # 1.2.3
#       #     MAJOR=${VERSION%%.*}                 # 1
#       #     MAJOR_MINOR=$(echo "$VERSION" | awk -F. '{print $1"."$2}') # 1.2
#       #     SHORT_SHA=${GITHUB_SHA::7}

#       #     echo "TAG=$TAG" >> $GITHUB_ENV
#       #     echo "VERSION=$VERSION" >> $GITHUB_ENV
#       #     echo "MAJOR=$MAJOR" >> $GITHUB_ENV
#       #     echo "MAJOR_MINOR=$MAJOR_MINOR" >> $GITHUB_ENV
#       #     echo "SHORT_SHA=$SHORT_SHA" >> $GITHUB_ENV

#       - name: Determine tag and validate semver
#         id: parse
#         run: |
#           set -euo pipefail

#           # Source tag:
#           if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
#             RAW_TAG="${{ github.event.inputs.version }}"
#           else
#             RAW_TAG="${GITHUB_REF#refs/tags/}"
#           fi

#           # Normalize (strip optional leading v)
#           VERSION="${RAW_TAG#v}"

#           # semver regex that accepts prerelease and build metadata per semver.org
#           SEMVER_RE='^(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)(?:-([0-9A-Za-z-]+(?:\.[0-9A-Za-z-]+)*))?(?:\+([0-9A-Za-z-]+(?:\.[0-9A-Za-z-]+)*))?$'

#           if ! echo "$VERSION" | grep -Eq "$SEMVER_RE"; then
#             echo "Invalid semantic version: '$RAW_TAG'. Expected MAJOR.MINOR.PATCH with optional -prerelease and +build."
#             exit 1
#           fi

#           CORE="$(echo "$VERSION" | sed -e 's/-.*$//' -e 's/\+.*$//')"
#           MAJOR="${CORE%%.*}"
#           MAJOR_MINOR="$(echo "$CORE" | awk -F. '{print $1"."$2}')"

#           # is there prerelease or build metadata?
#           if echo "$VERSION" | grep -Eq '[-+]'; then
#             IS_RELEASE=false
#           else
#             IS_RELEASE=true
#           fi
#           IS_RELEASE=false  #TODO TEMPORARILY DISABLE RELEASE TAGS FOR NOW

#           # sanitize for docker tags: convert '+' to '-' and lowercase
#           DOCKER_VER="$(echo "$VERSION" | sed 's/+/-/g' | tr '[:upper:]' '[:lower:]')"

#           SHORT_SHA="${GITHUB_SHA::7}"
#           TAG_FULL="v${VERSION}"   # canonical tag with leading v

#           echo "::notice::Resolved version='$VERSION' (canonical tag='$TAG_FULL'), docker_tag='$DOCKER_VER', is_release=$IS_RELEASE"

#           # Build the newline-separated tags list for build-push-action
#           # Always push full semver and short sha; for releases also add MAJOR_MINOR, MAJOR and latest
#           TAGS="${REGISTRY}/${IMAGE}:${MAJOR_MINOR}, ${REGISTRY}/${IMAGE}:${SHORT_SHA}"
#           if [ "$IS_RELEASE" = "true" ]; then
#             TAGS="${TAGS}, ${REGISTRY}/${IMAGE}:${MAJOR_MINOR}, ${REGISTRY}/${IMAGE}:${MAJOR}, ${REGISTRY}/${IMAGE}:latest"
#           fi

#           # Export outputs (use GITHUB_OUTPUT format)
#           echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
#           echo "docker_ver=${DOCKER_VER}" >> "$GITHUB_OUTPUT"
#           echo "core=${CORE}" >> "$GITHUB_OUTPUT"
#           echo "major=${MAJOR}" >> "$GITHUB_OUTPUT"
#           echo "major_minor=${MAJOR_MINOR}" >> "$GITHUB_OUTPUT"
#           echo "is_release=${IS_RELEASE}" >> "$GITHUB_OUTPUT"
#           echo "short_sha=${SHORT_SHA}" >> "$GITHUB_OUTPUT"
#           echo "tag_full=${TAG_FULL}" >> "$GITHUB_OUTPUT"
#           # tags is multiline output
#           echo "tags<<EOF" >> "$GITHUB_OUTPUT"
#           printf "%s\n" "$TAGS" >> "$GITHUB_OUTPUT"
#           echo "EOF" >> "$GITHUB_OUTPUT"

#           # ECHO outputs
#           echo "version=${VERSION}"
#           echo "docker_ver=${DOCKER_VER}"
#           echo "core=${CORE}"
#           echo "major=${MAJOR}"
#           echo "major_minor=${MAJOR_MINOR}"
#           echo "is_release=${IS_RELEASE}"
#           echo "short_sha=${SHORT_SHA}"
#           echo "tag_full=${TAG_FULL}"
#           # tags is multiline output
#           echo "tags<<EOF"
#           printf "%s\n" "$TAGS"
#           echo "EOF"

#       - name: Login to GitHub Container Registry
#         uses: docker/login-action@v3
#         with:
#           registry: ${{ env.REGISTRY }}
#           username: ${{ github.actor }}
#           password: ${{ secrets.GITHUB_TOKEN }}

#       - name: Extract metadata
#         id: meta
#         uses: docker/metadata-action@v5
#         with:
#           images: ${{ env.REGISTRY }}/${{ env.IMAGE }}
#           # tags: ${{ steps.parse.outputs.tags }}
#           tags: |
#             type=ref,event=branch
#             type=ref,event=pr
#             type=semver,pattern={{version}}
#             type=semver,pattern={{major}}.{{minor}}
#             type=sha,prefix=sha-
#             type=raw,value=latest,enable={{is_default_branch}}

#       # - name: Build and push image
#       #   uses: docker/build-push-action@v4
#       #   with:
#       #     context: .
#       #     push: true
#       #     tags: ${{ steps.parse.outputs.tags }}

#       - name: Build and push base image
#         id: build
#         uses: docker/build-push-action@v5
#         with:
#           context: apps/daily-diary/diary-server-container
#           file: apps/daily-diary/diary-server-container/Dockerfile
#           push: true
#           # push: ${{ github.ref == 'refs/heads/main' || github.event.inputs.push_to_registry == 'true' }}
#           tags: ${{ steps.parse.outputs.tags }}
#           labels: ${{ steps.meta.outputs.labels }}
#           # COHERENT CACHING: GHCR only (no GHA cache)
#           # Images in GHCR serve as cache - pull latest before build
#           cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE }}:latest
#           cache-to: type=inline
#           provenance: ${{ github.event_name != 'pull_request' }}
#           sbom: ${{ github.event_name != 'pull_request' }}

#       - name: Export local image for downstream jobs
#         # if: github.event_name == 'pull_request'
#         run: docker save -o /tmp/base-image.tar ${{ env.IMAGE }}:latest

#       - name: Upload base image artifact
#         # if: github.event_name == 'pull_request'
#         uses: actions/upload-artifact@v4
#         with:
#           name: base-image
#           path: /tmp/base-image.tar
#           retention-days: 1
