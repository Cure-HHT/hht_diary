---
# IMPLEMENTS REQUIREMENTS:
#   REQ-d00027: Containerized Development Environments
#   REQ-d00030: CI/CD Integration
#   REQ-d00033: FDA Validation Documentation
#   REQ-d00035: Security and Compliance
#
# Clinical Diary Docker Image Build & Publish
# Builds, signs, and publishes Docker images to GitHub Container Registry

# Build Diary Docker images to ghcr.io when a semver tag (vMAJOR.MINOR.PATCH) is pushed.
# Tags produced: full semver (1.2.3), major.minor (1.2), major (1), latest, short-sha

# Build & push Docker image to ghcr.io when a semver tag (vMAJOR.MINOR.PATCH) is pushed
# or when manually dispatched via the Actions UI with an input `version`.
# - Restores the "Determine tag and validate semver" step (id: parse)
# - Adds workflow_dispatch with an input string named `version`
# - Builds/pushes tags computed from the semver (full, short-sha, and release shortcuts)

name: Build and Push diary-server images

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build and push (example: v1.2.3, 1.2.3, 1.2.3-beta.1)'
        required: true
        default: ''
      create_tag:
        description: 'If true, create/push the annotated git tag back to the repo (requires push permission).'
        required: false
        default: 'false'
  # push:
  #   branches:
  #     - main
  #     - 'release/**'
  #   paths:
  #     - 'tools/dev-env/docker/**'
  #     - 'tools/dev-env/docker-compose.yml'
  #     - '.github/workflows/build-publish-images.yml'
  # pull_request:
  #   paths:
  #     - 'tools/dev-env/docker/**'
  #     - 'tools/dev-env/docker-compose.yml'
  #     - '.github/workflows/build-publish-images.yml'
  # workflow_dispatch:
  #   inputs:
  #     push_to_registry:
  #       description: 'Push images to GitHub Container Registry'
  #       required: false
  #       default: 'true'
  #       type: choice
  #       options:
  #         - 'true'
  #         - 'false'

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: cure-hht/diary-server
  DART_VERSION: 3.10.7
  BASE_IMAGE: 'ghcr.io/cure-hht/dart-base:3.10.7'
  DEBIAN_IMAGE: 'gcr.io/distroless/cc-debian12:nonroot'

permissions:
  contents: read
  packages: write
  id-token: write  # For Cosign signing

jobs:
  build-diary-server:
    name: Build diary-server Image
    runs-on: ubuntu-latest

    outputs:
      image_tag: ${{ steps.parse.outputs.tags }}
      image_digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: Free up disk space
        run: |
          echo "Disk space before cleanup:"
          df -h
          echo "Cleaning up unnecessary files..."
          docker image prune -af
          docker container prune -f
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /usr/local/share/boost
          echo "Disk space after cleanup:"
          df -h

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          # Use **docker** driver for PR builds to enable docker load/image sharing between jobs
          # Use **docker-container** driver (default) for main builds to support provenance/SBOM
          driver: docker-container

      - name: Log in to GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine tag and validate semver
        id: parse
        run: |
          set -euo pipefail

          # Source tag:
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            RAW_TAG="${{ github.event.inputs.version }}"
          else
            RAW_TAG="${GITHUB_REF#refs/tags/}"
          fi

          # Normalize (strip optional leading v)
          VERSION="${RAW_TAG#v}"

          # semver regex that accepts prerelease and build metadata per semver.org
          SEMVER_RE='^(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)(?:-([0-9A-Za-z-]+(?:\.[0-9A-Za-z-]+)*))?(?:\+([0-9A-Za-z-]+(?:\.[0-9A-Za-z-]+)*))?$'

          if ! echo "$VERSION" | grep -Eq "$SEMVER_RE"; then
            echo "Invalid semantic version: '$RAW_TAG'. Expected MAJOR.MINOR.PATCH with optional -prerelease and +build."
            exit 1
          fi

          CORE="$(echo "$VERSION" | sed -e 's/-.*$//' -e 's/\+.*$//')"
          MAJOR="${CORE%%.*}"
          MAJOR_MINOR="$(echo "$CORE" | awk -F. '{print $1"."$2}')"

          # is there prerelease or build metadata?
          if echo "$VERSION" | grep -Eq '[-+]'; then
            IS_RELEASE=false
          else
            IS_RELEASE=true
          fi
          IS_RELEASE=false  #TODO TEMPORARILY DISABLE RELEASE FOR NOW

          # sanitize for docker tags: convert '+' to '-' and lowercase
          DOCKER_VER="$(echo "$VERSION" | sed 's/+/-/g' | tr '[:upper:]' '[:lower:]')"

          SHORT_SHA="${GITHUB_SHA::7}"
          TAG_FULL="v${VERSION}"   # canonical tag with leading v

          echo "::notice::Resolved version='$VERSION' (canonical tag='$TAG_FULL'), docker_tag='$DOCKER_VER', is_release=$IS_RELEASE"

          # Build the newline-separated tags list for build-push-action
          # Always push full semver and short sha; for releases also add MAJOR_MINOR, MAJOR and latest
          TAGS="${REGISTRY}/${IMAGE_PREFIX}:${MAJOR_MINOR}, ${REGISTRY}/${IMAGE_PREFIX}:${SHORT_SHA}, ${REGISTRY}/${IMAGE_PREFIX}:latest"
          if [ "$IS_RELEASE" = "true" ]; then
            TAGS="${TAGS}, ${REGISTRY}/${IMAGE_PREFIX}:${MAJOR_MINOR}, ${REGISTRY}/${IMAGE_PREFIX}:${MAJOR}, ${REGISTRY}/${IMAGE_PREFIX}:latest"
          fi

          # Export outputs (use GITHUB_OUTPUT format)
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "docker_ver=${DOCKER_VER}" >> "$GITHUB_OUTPUT"
          echo "core=${CORE}" >> "$GITHUB_OUTPUT"
          echo "major=${MAJOR}" >> "$GITHUB_OUTPUT"
          echo "major_minor=${MAJOR_MINOR}" >> "$GITHUB_OUTPUT"
          echo "is_release=${IS_RELEASE}" >> "$GITHUB_OUTPUT"
          echo "short_sha=${SHORT_SHA}" >> "$GITHUB_OUTPUT"
          echo "tag_full=${TAG_FULL}" >> "$GITHUB_OUTPUT"
          # tags is multiline output
          echo "tags<<EOF" >> "$GITHUB_OUTPUT"
          printf "%s\n" "$TAGS" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

          # ECHO outputs
          echo "version=${VERSION}"
          echo "docker_ver=${DOCKER_VER}"
          echo "core=${CORE}"
          echo "major=${MAJOR}"
          echo "major_minor=${MAJOR_MINOR}"
          echo "is_release=${IS_RELEASE}"
          echo "short_sha=${SHORT_SHA}"
          echo "tag_full=${TAG_FULL}"
          # tags is multiline output
          echo "tags<<EOF"
          printf "%s\n" "$TAGS"
          echo "EOF"

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-dev
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix=sha-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push diary-server image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/daily-diary/diary-server-container/Dockerfile
          # IMPORTANT: platforms linux/amd64 is required for Cloud Run compatibility
          platforms: linux/amd64
          build-args: |
            BASE_IMAGE=${{ env.BASE_IMAGE }}
            DEBIAN_IMAGE=${{ env.DEBIAN_IMAGE }}
          push: true
          tags: ${{ steps.parse.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}:latest
          cache-to: type=inline
          provenance: true
          sbom: true

      # - name: Tag image for local use
      #   # if: github.event_name == 'pull_request'
      #   run: |
      #     # Extract first tag from metadata action output
      #     IFS=',' read -ra TAGS <<< '${{ steps.parse.outputs.tags }}'
      #     docker tag "${TAGS[0]}" diary-server:latest
      #     # FIRST_TAG=$(echo '${{ steps.parse.outputs.tags }}' | head -n1)
      #     # docker tag "$FIRST_TAG" diary-server:latest
      #     #     - name: Export local image for downstream jobs
  
      # - name: Export local image for downstream jobs
      #   # if: github.event_name == 'pull_request'
      #   run: docker save -o /tmp/base-image.tar diary-server:latest

      # - name: Upload dev image artifact
      #   # if: github.event_name == 'pull_request'
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: dev-image
      #     path: /tmp/dev-image.tar
      #     retention-days: 1

  sign-and-sbom:
    name: Sign Images & Attach SBOMs
    runs-on: ubuntu-latest
    needs: [build-diary-server]

    steps:
      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Install Syft
        uses: anchore/sbom-action/download-syft@v0

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Sign dev image
        run: |
          cosign sign --yes \
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}:${{ needs.build-diary-server.outputs.image_digest }}

      - name: Generate SBOM for dev image
        run: |
          syft ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}:${{ needs.build-diary-server.outputs.image_digest }} \
            -o spdx-json \
            --file dev-sbom.spdx.json

      - name: Upload SBOMs as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sboms-${{ github.sha }}
          path: |
            *-sbom.spdx.json
          retention-days: 90

      - name: Attach SBOM attestation to dev image
        run: |
          cosign attest --yes \
            --predicate dev-sbom.spdx.json \
            --type spdxjson \
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}:${{ needs.build-diary-server.outputs.image_digest }}


  # verify-images:
  #   name: Verify Image Signatures
  #   runs-on: ubuntu-latest
  #   needs: [sign-and-sbom, build-base, build-dev, build-qa]
  #   if: github.event_name != 'pull_request' && (github.ref == 'refs/heads/main' || github.event.inputs.push_to_registry == 'true')

  #   steps:
  #     - name: Install Cosign
  #       uses: sigstore/cosign-installer@v3

  #     - name: Log in to GitHub Container Registry
  #       uses: docker/login-action@v3
  #       with:
  #         registry: ${{ env.REGISTRY }}
  #         username: ${{ github.actor }}
  #         password: ${{ secrets.GITHUB_TOKEN }}

  #     - name: Verify base image signature
  #       run: |
  #         echo "Verifying base image..."
  #         cosign verify \
  #           --certificate-identity-regexp="https://github.com/${{ github.repository }}" \
  #           --certificate-oidc-issuer=https://token.actions.githubusercontent.com \
  #           ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-base@${{ needs.build-base.outputs.image_digest }}

  #     - name: Verify dev image signature
  #       run: |
  #         echo "Verifying dev image..."
  #         cosign verify \
  #           --certificate-identity-regexp="https://github.com/${{ github.repository }}" \
  #           --certificate-oidc-issuer=https://token.actions.githubusercontent.com \
  #           ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-dev@${{ needs.build-dev.outputs.image_digest }}

  #     - name: Verify QA image signature
  #       run: |
  #         echo "Verifying qa image..."
  #         cosign verify \
  #           --certificate-identity-regexp="https://github.com/${{ github.repository }}" \
  #           --certificate-oidc-issuer=https://token.actions.githubusercontent.com \
  #           ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-qa@${{ needs.build-qa.outputs.image_digest }}

  # summary:
  #   name: Build Summary
  #   runs-on: ubuntu-latest
  #   needs: [build-base, build-dev, build-qa]
  #   if: always()

  #   steps:
  #     - name: Generate summary
  #       run: |
  #         echo "# Docker Image Build Summary" >> $GITHUB_STEP_SUMMARY
  #         echo "" >> $GITHUB_STEP_SUMMARY
  #         echo "**Event**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
  #         echo "**Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
  #         echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
  #         echo "" >> $GITHUB_STEP_SUMMARY
  #         echo "## Images Built" >> $GITHUB_STEP_SUMMARY
  #         echo "" >> $GITHUB_STEP_SUMMARY
  #         echo "- ✅ Base image" >> $GITHUB_STEP_SUMMARY
  #         echo "- ✅ Dev image" >> $GITHUB_STEP_SUMMARY
  #         echo "- ✅ QA image" >> $GITHUB_STEP_SUMMARY
  #         echo "- ✅ Ops image" >> $GITHUB_STEP_SUMMARY
  #         echo "- ✅ Management image" >> $GITHUB_STEP_SUMMARY
  #         echo "" >> $GITHUB_STEP_SUMMARY

  #         if [ "${{ github.event_name }}" != "pull_request" ]; then
  #           echo "## Published to GHCR" >> $GITHUB_STEP_SUMMARY
  #           echo "" >> $GITHUB_STEP_SUMMARY
  #           echo "Images available at: \`${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-*\`" >> $GITHUB_STEP_SUMMARY
  #           echo "" >> $GITHUB_STEP_SUMMARY
  #           echo "- Image signatures verified with Cosign" >> $GITHUB_STEP_SUMMARY
  #           echo "- SBOMs generated with Syft" >> $GITHUB_STEP_SUMMARY
  #         else
  #           echo "## Build Verification Only" >> $GITHUB_STEP_SUMMARY
  #           echo "" >> $GITHUB_STEP_SUMMARY
  #           echo "Pull request builds are not pushed to registry." >> $GITHUB_STEP_SUMMARY
  #         fi