---
# IMPLEMENTS REQUIREMENTS:
#   REQ-o00044: GCP Authentication via Workload Identity Federation
#   REQ-o00043: Automated Deployment Pipeline
#
# This workflow tests GCP authentication using Workload Identity Federation
# Triggered manually via workflow_dispatch or called from build-portal-server.yml

name: 'Deploy portal-service to GCP'

on:
  workflow_dispatch:
    inputs:
      image_path:
        description: 'Full ghcr.io image path (e.g., ghcr.io/cure-hht/portal-server:v1.2.3)'
        required: true
        type: string
      version:
        description: 'Version being deployed (e.g., 1.2.3, abc1234 for main branch)'
        required: false
        type: string
  workflow_call:
    inputs:
      image_path:
        description: 'Full ghcr.io image path (e.g., ghcr.io/cure-hht/portal-server:v1.2.3)'
        required: true
        type: string
      version:
        description: 'Version being deployed (e.g., 1.2.3, abc1234 for main branch)'
        required: false
        type: string
    secrets:
      DOPPLER_TOKEN:
        description: 'Doppler service token for the target environment'
        required: true

env:
  GCP_REPO_PATH: 'europe-west9-docker.pkg.dev/${{ vars.GCP_PROJECT_ID }}/ghcr-remote'

jobs:
  deploy-portal-service:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'  # Required to request the OIDC token

    steps:
      - uses: 'actions/checkout@v4'

      - id: 'auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: projects/${{ vars.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: '${{ vars.GCP_SA_EMAIL }}'

      - name: 'Test the Connection'
        run: |
          gcloud config set project ${{ vars.GCP_PROJECT_ID }}

          # Try to describe the image (validates it exists)
          echo "Checking image metadata..."
          gcloud artifacts docker images describe "$GAR_PATH" --format="table(image_summary.digest,image_summary.fully_qualified_digest,package,tags)" || {
            echo "::warning::Image not found via describe, attempting docker pull..."
            docker pull "$GAR_PATH"
          }

          echo "✅ Image validation successful: $GAR_PATH"

      - name: 'Deploy to Cloud Run'
        run: |
          GAR_PATH="${{ steps.translate-path.outputs.gar_path }}"
          VERSION="${{ inputs.version }}"
          echo "Deploying image to Cloud Run: $GAR_PATH"
          if [ -n "$VERSION" ]; then
            echo "Version: $VERSION"
          fi

          gcloud run services update portal-service \
            --region=europe-west9 \
            --project=${{ vars.GCP_DEPLOY2_PROJECT_ID }} \
            --image="$GAR_PATH" \
            --set-env-vars="DOPPLER_TOKEN=${{ secrets.DOPPLER_TOKEN }},ENVIRONMENT=dev"

          echo "✅ Cloud Run deployment successful${VERSION:+ (version: $VERSION)}"

      - name: 'Display authentication info'
        run: |
          echo "GCP Project: ${{ vars.GCP_PROJECT_ID }}"
          gcloud auth list
          gcloud artifacts docker images list ${{ env.GCP_REPO_PATH }}
