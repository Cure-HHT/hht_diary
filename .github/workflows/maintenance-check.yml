# Maintenance Enforcement - FDA 21 CFR Part 11 Compliance
#
# IMPLEMENTS REQUIREMENTS:
#   REQ-o00052: CI/CD Pipeline with Automated Quality Gates
#
# Enforces quarterly review of critical configuration files
# to ensure FDA compliance and system validation

name: Maintenance Check

on:
  schedule:
    # Run on the 1st of every month at 9:00 UTC
    - cron: '0 9 1 * *'
  workflow_dispatch: # Allow manual trigger
  pull_request:
    paths:
      - 'tools/dev-env/docker/**'
      - '.github/workflows/maintenance-check.yml'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check-maintenance-status:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git log analysis

      - name: Check file modification dates
        id: check_dates
        run: |
          # Files that require quarterly review (90 days)
          QUARTERLY_FILES=(
            "tools/dev-env/docker/devops.Dockerfile"
            "tools/dev-env/docker/audit.Dockerfile"
          )

          # Files that require annual review (365 days)
          ANNUAL_FILES=(
            "tools/dev-env/docker/ci.Dockerfile"
          )

          CURRENT_DATE=$(date +%s)
          STALE_FILES=()

          echo "=== Checking Quarterly Review Files (90 days) ==="
          for file in "${QUARTERLY_FILES[@]}"; do
            if [ -f "$file" ]; then
              LAST_MOD=$(git log -1 --format="%at" -- "$file")
              DAYS_AGO=$(( (CURRENT_DATE - LAST_MOD) / 86400 ))
              echo "üìÑ $file: Last modified $DAYS_AGO days ago"

              if [ $DAYS_AGO -gt 90 ]; then
                STALE_FILES+=("$file (${DAYS_AGO} days - QUARTERLY REVIEW OVERDUE)")
              fi
            else
              echo "‚ö†Ô∏è  $file: NOT FOUND"
            fi
          done

          echo ""
          echo "=== Checking Annual Review Files (365 days) ==="
          for file in "${ANNUAL_FILES[@]}"; do
            if [ -f "$file" ]; then
              LAST_MOD=$(git log -1 --format="%at" -- "$file")
              DAYS_AGO=$(( (CURRENT_DATE - LAST_MOD) / 86400 ))
              echo "üìÑ $file: Last modified $DAYS_AGO days ago"

              if [ $DAYS_AGO -gt 365 ]; then
                STALE_FILES+=("$file (${DAYS_AGO} days - ANNUAL REVIEW OVERDUE)")
              fi
            else
              echo "‚ö†Ô∏è  $file: NOT FOUND"
            fi
          done

          # Check if any files are stale
          if [ ${#STALE_FILES[@]} -gt 0 ]; then
            echo ""
            echo "‚ùå MAINTENANCE OVERDUE"
            echo ""
            echo "The following files have not been reviewed:"
            for stale in "${STALE_FILES[@]}"; do
              echo "  ‚ùå $stale"
            done
            echo ""
            echo "FDA 21 CFR Part 11 Compliance Requirement:"
            echo "  - Quarterly review: Dockerfile versions, warning baselines"
            echo "  - Annual review: Base image configuration"
            echo ""
            echo "To resolve:"
            echo "  1. Review the file for necessary updates"
            echo "  2. Update version numbers if newer stable versions exist"
            echo "  3. Test the changes"
            echo "  4. Commit with message: [MAINTENANCE] Quarterly review - <date>"
            echo ""
            exit 1
          else
            echo ""
            echo "‚úÖ All maintenance reviews are up to date"
          fi

      - name: Check for outdated tool versions
        if: always()
        run: |
          echo "=== Checking for Outdated Tool Versions ==="
          echo ""
          echo "Current pinned versions (from Dockerfiles):"
          echo ""

          # Extract pinned versions from versions.env
          echo "üì¶ Pinned versions from .github/versions.env:"
          echo ""
          cat .github/versions.env | grep -v '^#' | grep -v '^$' | grep '=' | while read line; do
            echo "  $line"
          done
          echo ""

          echo "üì¶ CI container tool versions:"
          grep "ARG.*VERSION" tools/dev-env/docker/ci.Dockerfile | head -10 || true
          echo ""

          echo "üì¶ DevOps container tool versions:"
          grep "ARG.*VERSION" tools/dev-env/docker/devops.Dockerfile | head -10 || true
          echo ""

          echo "‚ÑπÔ∏è  This is informational - manual review required for FDA compliance"
          echo "   Review release notes and test before updating pinned versions"
          echo "   All versions centralized in .github/versions.env"

      - name: Generate maintenance report
        if: always()
        run: |
          REPORT_FILE="maintenance-report-$(date +%Y-%m-%d).md"

          cat > "$REPORT_FILE" <<EOF
          # Docker Environment Maintenance Report

          **Generated**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Repository**: \${{ github.repository }}
          **Branch**: \${{ github.ref_name }}

          ## Review Status

          This report documents the maintenance status of the Docker development environment
          for FDA 21 CFR Part 11 compliance.

          ### Files Checked

          **Quarterly Review Required (90 days)**:
          - tools/dev-env/docker/devops.Dockerfile
          - tools/dev-env/docker/audit.Dockerfile

          **Annual Review Required (365 days)**:
          - tools/dev-env/docker/ci.Dockerfile

          ### Pinned Tool Versions

          EOF

          echo "\`\`\`" >> "$REPORT_FILE"
          grep "ENV.*_VERSION" tools/dev-env/docker/*.Dockerfile | sed 's/.*ENV //' >> "$REPORT_FILE"
          echo "\`\`\`" >> "$REPORT_FILE"

          cat >> "$REPORT_FILE" <<EOF

          ### Compliance Notes

          - **Version Pinning**: All critical tools have pinned versions for reproducibility
          - **Review Frequency**: Quarterly for role-specific images, Annual for base image
          - **Update Policy**: Security patches applied immediately, feature updates quarterly
          - **Testing Required**: All version updates must pass full test suite before merge

          ### Next Steps

          1. Review latest releases for each pinned tool
          2. Check security advisories
          3. Test any necessary updates in dev environment
          4. Document changes in commit message with [MAINTENANCE] prefix

          ---

          **Audit Trail**: This report generated automatically by GitHub Actions
          **Workflow**: .github/workflows/maintenance-check.yml
          EOF

          echo "üìÑ Report generated: $REPORT_FILE"
          cat "$REPORT_FILE"

      - name: Notify Slack if maintenance overdue
        if: failure() && github.event_name == 'schedule'
        uses: slackapi/slack-github-action@v2.1.1
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_APP_OATH_TOKEN }}
          errors: true
          payload: |
            channel: "${{ secrets.SLACK_CHANNEL_DEVOPS }}"
            text: ":warning: *Maintenance Overdue: Docker Environment Review Required*\n\nOne or more Docker environment files have not been reviewed in the required timeframe.\n\n*FDA 21 CFR Part 11 Compliance*\n- Quarterly (90 days): Role-specific Dockerfiles, warning baselines\n- Annual (365 days): Base image configuration\n\n*Required Actions*\n1. Review files listed in the workflow run\n2. Check for updated tool versions\n3. Test any necessary updates\n4. Commit with: `[MAINTENANCE] Quarterly review - <date>`\n\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View workflow run>"
