#!/bin/bash
# =====================================================
# Session-Start Hook: Outdated Requirements Notification
# =====================================================
#
# This hook is part of the simple-requirements plugin.
# It notifies the user about requirements that have changed
# and may require implementation updates.
#
# Plugin: simple-requirements v1.0.0
# Location: tools/anspar-cc-plugins/plugins/simple-requirements/
#
# =====================================================

set -e

# Colors for output (may not be needed but helpful for debugging)
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Plugin root (resolved relative to this script)
PLUGIN_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

# Path to tracking file (relative to repo root)
TRACKING_FILE="${PLUGIN_ROOT}/../../../../untracked-notes/outdated-implementations.json"

# Check if tracking file exists
if [ ! -f "$TRACKING_FILE" ]; then
    # No tracking file, nothing to report
    exit 0
fi

# Check if tracking file has any outdated requirements
OUTDATED_COUNT=$(jq -r '.outdated_requirements | length' "$TRACKING_FILE" 2>/dev/null || echo "0")

if [ "$OUTDATED_COUNT" -eq 0 ]; then
    # No outdated requirements
    exit 0
fi

# Build notification message
echo "ðŸ“‹ REQUIREMENTS CHANGED"
echo ""
echo "The following requirements have been modified and may need implementation updates:"
echo ""

# Show each outdated requirement
jq -r '.outdated_requirements[] | "â€¢ REQ-\(.req_id): \(.title)\n  File: \(.file) | Hash: \(.old_hash) â†’ \(.new_hash)"' "$TRACKING_FILE"

echo ""
echo "Actions:"
echo "  â€¢ View requirement: python3 ${PLUGIN_ROOT}/scripts/get-requirement.py REQ-{id}"
echo "  â€¢ Mark as verified: python3 ${PLUGIN_ROOT}/scripts/mark-verified.py REQ-{id}"
echo "  â€¢ See all changes: python3 ${PLUGIN_ROOT}/scripts/detect-changes.py --format summary"
echo ""

exit 0
