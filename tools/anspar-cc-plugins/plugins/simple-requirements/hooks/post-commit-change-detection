#!/bin/bash
# =====================================================
# Post-Commit Hook: Requirement Change Detection
# =====================================================
#
# This hook is part of the simple-requirements plugin.
# It detects requirement changes after commits and updates
# the tracking file for outdated implementations.
#
# Plugin: simple-requirements v1.0.0
# Location: tools/anspar-cc-plugins/plugins/simple-requirements/
# Implementation:
#   - scripts/detect-changes.py (detect requirement changes)
#   - scripts/update-tracking.py (maintain tracking file)
#
# =====================================================

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Plugin root (resolved relative to this script)
PLUGIN_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

# Check if spec/*.md files were modified in last commit
SPEC_FILES_CHANGED=$(git diff-tree --no-commit-id --name-only -r HEAD | grep '^spec/.*\.md$' || true)

if [ -z "$SPEC_FILES_CHANGED" ]; then
    # No spec files changed, skip change detection
    exit 0
fi

echo ""
echo -e "${BLUE}üîç Detecting requirement changes from commit...${NC}"
echo ""

# Paths to scripts
DETECT_SCRIPT="${PLUGIN_ROOT}/scripts/detect-changes.py"
UPDATE_SCRIPT="${PLUGIN_ROOT}/scripts/update-tracking.py"
TEMP_CHANGES="/tmp/req-changes-$$.json"

# Check if scripts exist
if [ ! -f "$DETECT_SCRIPT" ]; then
    echo -e "${RED}‚ùå ERROR: Change detection script not found: $DETECT_SCRIPT${NC}"
    exit 1
fi

if [ ! -f "$UPDATE_SCRIPT" ]; then
    echo -e "${RED}‚ùå ERROR: Update tracking script not found: $UPDATE_SCRIPT${NC}"
    exit 1
fi

# Run change detection
if ! python3 "$DETECT_SCRIPT" --format json > "$TEMP_CHANGES"; then
    echo -e "${RED}‚ùå Change detection failed${NC}"
    rm -f "$TEMP_CHANGES"
    exit 1
fi

# Parse results
CHANGED_COUNT=$(jq -r '.summary.changed_count' "$TEMP_CHANGES")
NEW_COUNT=$(jq -r '.summary.new_count' "$TEMP_CHANGES")
TOTAL_CHANGES=$((CHANGED_COUNT + NEW_COUNT))

if [ "$TOTAL_CHANGES" -eq 0 ]; then
    echo -e "${GREEN}‚úÖ No requirement changes detected${NC}"
    echo ""
    rm -f "$TEMP_CHANGES"
    exit 0
fi

# Update tracking file
echo -e "${YELLOW}üìù Found ${TOTAL_CHANGES} changed requirement(s)${NC}"
echo ""

if python3 "$UPDATE_SCRIPT" --input "$TEMP_CHANGES"; then
    echo ""
    echo -e "${YELLOW}‚ö†Ô∏è  IMPORTANT: Requirements have changed!${NC}"
    echo ""

    # Show summary
    if [ "$CHANGED_COUNT" -gt 0 ]; then
        echo -e "${YELLOW}   Modified requirements: ${CHANGED_COUNT}${NC}"
        jq -r '.changed_requirements[] | "   ‚Ä¢ REQ-\(.req_id): \(.title)"' "$TEMP_CHANGES"
    fi

    if [ "$NEW_COUNT" -gt 0 ]; then
        echo -e "${YELLOW}   New requirements: ${NEW_COUNT}${NC}"
        jq -r '.new_requirements[] | "   ‚Ä¢ REQ-\(.req_id): \(.title)"' "$TEMP_CHANGES"
    fi

    echo ""
    echo -e "   Tracking file updated: ${BLUE}untracked-notes/outdated-implementations.json${NC}"
    echo ""
    echo "Next steps:"
    echo "  1. Review changed requirements"
    echo "  2. Update implementations to match new requirements"
    echo "  3. Mark as verified: python3 ${PLUGIN_ROOT}/scripts/mark-verified.py REQ-{id}"
    echo ""

    # Optional: Create Linear verification tickets if enabled
    if [ "${LINEAR_CREATE_TICKETS:-false}" = "true" ]; then
        echo -e "${BLUE}üé´ Creating Linear verification tickets...${NC}"

        # Check if linear-api plugin is available
        LINEAR_SCRIPT="tools/anspar-cc-plugins/plugins/linear-api/scripts/create-verification-ticket.js"

        if [ -f "$LINEAR_SCRIPT" ]; then
            # Create ticket for each changed requirement
            jq -r '.changed_requirements[] | @json' "$TEMP_CHANGES" | while read -r req_json; do
                REQ_ID=$(echo "$req_json" | jq -r '.req_id')
                node "$LINEAR_SCRIPT" "$req_json" || echo -e "${YELLOW}   ‚ö†Ô∏è  Could not create ticket for REQ-${REQ_ID}${NC}"
            done
            echo ""
        else
            echo -e "${YELLOW}   ‚ÑπÔ∏è  Linear integration not available${NC}"
            echo "   Install: linear-api plugin for automatic ticket creation"
            echo ""
        fi
    fi
else
    echo -e "${RED}‚ùå Failed to update tracking file${NC}"
    rm -f "$TEMP_CHANGES"
    exit 1
fi

# Cleanup
rm -f "$TEMP_CHANGES"

exit 0
