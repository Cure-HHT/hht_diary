#!/bin/bash
# =====================================================
# Plugin-Expert: after-tool-use Hook
# =====================================================
#
# Automatically validates plugin JSON files after they
# are edited or created.
#
# Validates:
# - plugin.json (plugin metadata schema)
# - hooks.json (hook configuration schema)
#
# Provides immediate feedback on syntax and schema errors.
#
# =====================================================

TOOL_NAME="${CLAUDE_TOOL_NAME:-}"
TOOL_PARAMS="${CLAUDE_TOOL_PARAMS:-}"
TOOL_RESULT="${CLAUDE_TOOL_RESULT:-}"

# Only process file write operations
if [[ ! "$TOOL_NAME" =~ ^(Edit|Write)$ ]]; then
    exit 0
fi

# Extract file path
FILE_PATH=$(echo "$TOOL_PARAMS" | jq -r '.file_path // empty' 2>/dev/null)

if [[ -z "$FILE_PATH" ]]; then
    exit 0
fi

# Check if this is a plugin JSON file
BASENAME=$(basename "$FILE_PATH")

if [[ "$BASENAME" != "plugin.json" ]] && [[ "$BASENAME" != "hooks.json" ]]; then
    exit 0
fi

# Check if file is in a plugin directory
if [[ ! "$FILE_PATH" =~ (tools/anspar-marketplace/plugins/|plugins/) ]]; then
    exit 0
fi

# Check if file exists
if [[ ! -f "$FILE_PATH" ]]; then
    exit 0
fi

# =====================================================
# Run JSON Validation
# =====================================================

VALIDATION_SCRIPT="${CLAUDE_PLUGIN_ROOT}/utilities/validate-plugin-json.sh"

if [[ ! -x "$VALIDATION_SCRIPT" ]]; then
    echo "‚ö†Ô∏è JSON validation script not found or not executable"
    exit 0
fi

echo ""
echo "üîç Auto-validating: $BASENAME"
echo ""

# Run validation and capture output
if "$VALIDATION_SCRIPT" "$FILE_PATH"; then
    echo ""
    echo "‚úÖ JSON validation passed!"
    echo ""
else
    echo ""
    echo "‚ùå JSON validation failed. Please fix the errors above."
    echo ""
    # Don't block the operation, just warn
fi

exit 0
