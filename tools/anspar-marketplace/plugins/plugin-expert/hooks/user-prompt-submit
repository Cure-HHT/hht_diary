#!/bin/bash
# =====================================================
# UserPromptSubmit Hook - Plugin-Expert Plugin
# =====================================================
#
# Detects plugin development work and auto-invokes
# PluginExpert agent for architectural guidance.
#
# This hook provides proactive architectural enforcement
# by analyzing user prompts for patterns that indicate:
# - Plugin creation or modification
# - Hook development
# - Agent/skill work
# - Cross-plugin integration
#
# =====================================================

set -e

# Read prompt from stdin
PROMPT=$(cat)

# Pattern detection scoring
PLUGIN_WORK_SCORE=0

# ===================================================
# HIGH-PRIORITY PATTERNS (Strong plugin work indicators)
# ===================================================

# Plugin-specific paths in prompt
if echo "$PROMPT" | grep -qE "tools/anspar-marketplace/plugins/"; then
    PLUGIN_WORK_SCORE=$((PLUGIN_WORK_SCORE + 15))
fi

# Direct plugin development actions
if echo "$PROMPT" | grep -qiE "(create|modify|update|design|implement|add|build) (a |the |new |).*plugin"; then
    PLUGIN_WORK_SCORE=$((PLUGIN_WORK_SCORE + 12))
fi

# Hook development
if echo "$PROMPT" | grep -qiE "(create|add|modify|update|implement) (a |the |)(hook|user-prompt-submit|session-start|pre-tool-use|post-tool-use|pre-commit|post-commit|commit-msg)"; then
    PLUGIN_WORK_SCORE=$((PLUGIN_WORK_SCORE + 10))
fi

# ===================================================
# MEDIUM-PRIORITY PATTERNS (Plugin-related mentions)
# ===================================================

# Explicit plugin keyword
if echo "$PROMPT" | grep -qiE "\\bplugin\\b"; then
    PLUGIN_WORK_SCORE=$((PLUGIN_WORK_SCORE + 8))
fi

# Marketplace or anspar-marketplace mentions
if echo "$PROMPT" | grep -qiE "(marketplace|anspar-marketplace|claude code plugin)"; then
    PLUGIN_WORK_SCORE=$((PLUGIN_WORK_SCORE + 8))
fi

# Hook-related work (general)
if echo "$PROMPT" | grep -qiE "\\b(hook|hooks\\.json)\\b"; then
    PLUGIN_WORK_SCORE=$((PLUGIN_WORK_SCORE + 7))
fi

# Agent or skill development
if echo "$PROMPT" | grep -qiE "(agent|sub-agent|skill) (for|in|integration|development)"; then
    PLUGIN_WORK_SCORE=$((PLUGIN_WORK_SCORE + 7))
fi

# ===================================================
# LOW-PRIORITY PATTERNS (Possible plugin context)
# ===================================================

# Plugin architecture terms
if echo "$PROMPT" | grep -qiE "(plugin architecture|plugin design|plugin structure)"; then
    PLUGIN_WORK_SCORE=$((PLUGIN_WORK_SCORE + 5))
fi

# Cross-plugin integration
if echo "$PROMPT" | grep -qiE "integrate .* (plugin|with)"; then
    PLUGIN_WORK_SCORE=$((PLUGIN_WORK_SCORE + 5))
fi

# ===================================================
# DECISION LOGIC
# ===================================================

# Threshold for auto-invoking PluginExpert
THRESHOLD=10

if [ $PLUGIN_WORK_SCORE -ge $THRESHOLD ]; then
    GUIDANCE="ðŸ”Œ PLUGIN WORK DETECTED

Plugin development/modification is architectural work that requires careful design.

âš¡ AUTO-INVOKING PluginExpert agent for:
- Architecture enforcement
- Separation of concerns validation
- Best practices guidance
- Integration pattern review

The PluginExpert will review your request and ensure proper plugin structure."

    ADDITIONAL_CONTEXT="PLUGIN WORK DETECTED - PluginExpert agent should be invoked immediately. The user's prompt relates to Claude Code plugin development. Plugin work score: $PLUGIN_WORK_SCORE (threshold: $THRESHOLD). AUTO-INVOKE PluginExpert agent NOW to provide architectural guidance."

    jq -n \
        --arg msg "$GUIDANCE" \
        --arg ctx "$ADDITIONAL_CONTEXT" \
        '{
          "systemMessage": $msg,
          "hookSpecificOutput": {
            "hookEventName": "UserPromptSubmit",
            "additionalContext": $ctx,
            "autoInvokeAgent": "PluginExpert"
          }
        }'
else
    # No plugin work detected - pass through silently
    echo '{"continue": true}'
fi

exit 0
