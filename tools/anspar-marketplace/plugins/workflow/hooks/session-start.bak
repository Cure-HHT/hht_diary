#!/bin/bash
# =====================================================
# SessionStart Hook
# =====================================================
#
# Provides workflow status context to Claude at session start.
# Claude will announce the status to the user.
#
# This is informational only - does not block session start.
#
# =====================================================

# Find plugin directory
PLUGIN_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
CHECK_SCRIPT="$PLUGIN_DIR/scripts/check-active-ticket.sh"

# Build status message
STATUS_MSG=""

# Check for active ticket
if [ -f "$CHECK_SCRIPT" ]; then
    if TICKET_ID=$("$CHECK_SCRIPT" 2>/dev/null); then
        STATUS_MSG="Active ticket: $TICKET_ID"

        # Show recent commits for this ticket (last 3)
        # Use git-dir to support both regular repos and worktrees
        GIT_DIR="$(git rev-parse --git-dir 2>/dev/null || echo "")"
        if [ -n "$GIT_DIR" ] && [ -f "$GIT_DIR/WORKFLOW_STATE" ]; then
            RECENT_COMMITS=$(jq -r '[.history[] | select(.action == "commit")] | .[-3:] | .[] | "  • \(.details.commitHash[:7]) - \(.timestamp | split("T")[0])"' "$GIT_DIR/WORKFLOW_STATE" 2>/dev/null || echo "")

            if [ -n "$RECENT_COMMITS" ]; then
                STATUS_MSG="$STATUS_MSG

Recent commits:
$RECENT_COMMITS"
            fi
        fi
    else
        STATUS_MSG="⚠️ No active ticket claimed

Before starting work, claim a ticket:
  tools/claude-marketplace/anspar-workflow/scripts/claim-ticket.sh CUR-XXX

Or resume a previously paused ticket:
  tools/claude-marketplace/anspar-workflow/scripts/resume-ticket.sh"
    fi
else
    STATUS_MSG="Workflow plugin installed but check script not found"
fi

# Output as JSON with additionalContext for Claude
# Use jq to properly escape the status message for JSON
CONTEXT="WORKFLOW STATUS:
$STATUS_MSG

IMPORTANT: Announce this workflow status to the user at the start of the session."

jq -n --arg ctx "$CONTEXT" '{
  "hookSpecificOutput": {
    "hookEventName": "SessionStart",
    "additionalContext": $ctx
  }
}'

exit 0
