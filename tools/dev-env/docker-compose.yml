# IMPLEMENTS REQUIREMENTS:
#   REQ-d00027: Containerized Development Environments
#   REQ-d00028: Role-Based Environment Separation
#   REQ-d00030: CI/CD Environment Parity
#   REQ-d00036: Shared Workspace and File Exchange
#
# Clinical Diary Development Environment — Debian 12 Topology
# Docker Compose configuration with purpose-built containers
#
# Topology:
#   ci           — All-in-one CI: build, test, lint, scan (build-only profile)
#   devops-main  — Shared infrastructure operations (admin project)
#   devops-sponsor — Per-sponsor operations (isolated by env vars)
#   audit        — Read-only audit: DB, cloud, code, OTS
#
# Usage:
#   docker compose up -d devops-main   # Start devops for shared infra
#   docker compose exec devops-main bash
#   SPONSOR_NAME=orion docker compose up -d devops-sponsor
#   docker compose up -d audit         # Start audit container
#   docker compose down                # Stop all containers
#
# See: tools/dev-env/README.md for complete setup instructions

services:
  # ============================================================
  # CI Image — All-in-one: build, test, lint, scan
  # Used by CI workflows. Not run locally by default.
  # Future: dev.Dockerfile will extend this for interactive use.
  # ============================================================
  ci:
    build:
      context: ./docker
      dockerfile: ci.Dockerfile
      platforms:
        - linux/amd64
    image: clinical-diary-ci:latest
    profiles:
      - build-only

  # ============================================================
  # DevOps — Shared infrastructure operations (admin project)
  # Terraform + gcloud for managing shared/admin GCP resources
  # ============================================================
  devops-main:
    build:
      context: ./docker
      dockerfile: devops.Dockerfile
      platforms:
        - linux/amd64
    image: clinical-diary-devops:latest
    container_name: clinical-diary-devops-main
    hostname: devops-main
    platform: linux/amd64

    user: "devuser:devuser"

    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G

    volumes:
      - ../../infrastructure/terraform:/workspace/terraform:cached
      - ../../:/workspace/src:ro
      - ${HOME}/.ssh:/home/devuser/.ssh:ro
      - ${HOME}/.gitconfig:/home/devuser/.gitconfig.host:ro

    environment:
      - ROLE=devops-main
      - TF_WORKSPACE=admin

    networks:
      - clinical-diary-net

    healthcheck:
      test: ["CMD", "terraform", "--version"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    stdin_open: true
    tty: true

  # ============================================================
  # DevOps — Per-sponsor operations (isolated)
  # Same image, differentiated by SPONSOR_NAME env var + volumes
  # Usage: SPONSOR_NAME=orion docker compose up -d devops-sponsor
  # ============================================================
  devops-sponsor:
    build:
      context: ./docker
      dockerfile: devops.Dockerfile
      platforms:
        - linux/amd64
    image: clinical-diary-devops:latest
    container_name: clinical-diary-devops-${SPONSOR_NAME:-default}
    hostname: devops-${SPONSOR_NAME:-default}
    platform: linux/amd64

    user: "devuser:devuser"

    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G

    volumes:
      - ../../infrastructure/terraform:/workspace/terraform:cached
      - ../../sponsor/${SPONSOR_NAME:-_empty}:/workspace/sponsor:ro
      - ../../:/workspace/src:ro
      - ${HOME}/.ssh:/home/devuser/.ssh:ro
      - ${HOME}/.gitconfig:/home/devuser/.gitconfig.host:ro

    environment:
      - ROLE=devops-sponsor
      - SPONSOR_NAME=${SPONSOR_NAME:-}

    networks:
      - clinical-diary-net

    healthcheck:
      test: ["CMD", "terraform", "--version"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    stdin_open: true
    tty: true

  # ============================================================
  # Audit Environment — Read-only access
  # DB, cloud, code, and OpenTimestamps verification
  # ============================================================
  audit:
    build:
      context: ./docker
      dockerfile: audit.Dockerfile
      platforms:
        - linux/amd64
    image: clinical-diary-audit:latest
    container_name: clinical-diary-audit
    hostname: audit
    platform: linux/amd64

    user: "devuser:devuser"

    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G

    volumes:
      - ../../:/workspace/src:ro
      - ../../infrastructure/terraform:/workspace/terraform:ro
      - ${HOME}/.ssh:/home/devuser/.ssh:ro

    networks:
      - clinical-diary-net

    healthcheck:
      test: ["CMD", "psql", "--version"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    stdin_open: true
    tty: true

# ============================================================
# Named Volumes (persistent storage)
# ============================================================
volumes:
  # Repository storage (git clones)
  clinical-diary-repos:
    driver: local
    labels:
      com.clinical-diary.description: "Git repository storage"
      com.clinical-diary.role: "all"

  # File exchange between roles
  clinical-diary-exchange:
    driver: local
    labels:
      com.clinical-diary.description: "Inter-role file exchange"
      com.clinical-diary.role: "all"

  # QA test reports
  qa-reports:
    driver: local
    labels:
      com.clinical-diary.description: "QA test reports and artifacts"
      com.clinical-diary.role: "qa"

# ============================================================
# Networks
# ============================================================
networks:
  clinical-diary-net:
    driver: bridge
    labels:
      com.clinical-diary.description: "Development environment network"
