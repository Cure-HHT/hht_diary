# IMPLEMENTS REQUIREMENTS:
#   REQ-d00027: Containerized Development Environments
#   REQ-d00030: CI/CD Environment Parity
#
# Docker Compose CI Override
# CI-specific configuration for GitHub Actions runners.
#
# Usage (no database):
#   docker compose -f docker-compose.yml -f docker-compose.ci.yml up ci
#
# Usage (with database):
#   docker compose -f docker-compose.yml -f docker-compose.ci.yml --profile db up ci postgres

services:
  ci:
    image: clinical-diary-ci:latest
    user: "devuser:devuser"
    stdin_open: true
    tty: true
    volumes:
      - ../../:/workspace/src:cached
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 6G
        reservations:
          cpus: '1'
          memory: 4G
    networks:
      - ci-net
    depends_on:
      postgres:
        condition: service_healthy
        required: false

  postgres:
    image: postgres:17-alpine
    profiles: ["db"]
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: clinical_diary_test
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - ci-net
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M

networks:
  ci-net:
    driver: bridge
