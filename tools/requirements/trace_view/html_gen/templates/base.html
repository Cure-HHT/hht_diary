<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>{% block title %}Requirements Traceability Matrix{% endblock %}</title>

    {# Embedded CSS from external stylesheet #}
    <style>
        {{ css|safe }}
    </style>

    {# Review mode CSS (conditional) #}
    {% if review_mode %}
    <style>
        {{ review_css|safe }}
    </style>
    {% endif %}

    {# External libraries for embedded mode (code viewer, markdown) #}
    {% if embed_content %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/vs2015.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.1/marked.min.js"></script>
    {% endif %}
</head>
<body{% if edit_mode %} class="edit-mode-available"{% endif %}{% if review_mode %} data-review-mode="true"{% endif %}>
<div class="app-layout">
    <div class="main-content">
        <div class="container">
            {# Title bar with stats and controls #}
            {% block title_bar %}
            <div class="title-bar">
                <h1>Requirements Traceability</h1>
                <div class="stats-badges">
                    <span class="stat-badge prd" id="badgePRD"
                          data-active="{{ stats.prd.active }}"
                          data-all="{{ stats.prd.all }}">PRD: {{ stats.prd.active }}</span>
                    <span class="stat-badge ops" id="badgeOPS"
                          data-active="{{ stats.ops.active }}"
                          data-all="{{ stats.ops.all }}">OPS: {{ stats.ops.active }}</span>
                    <span class="stat-badge dev" id="badgeDEV"
                          data-active="{{ stats.dev.active }}"
                          data-all="{{ stats.dev.all }}">DEV: {{ stats.dev.active }}</span>
                </div>
                <span class="version-badge">v{{ version }}</span>
                <button class="btn btn-legend" onclick="openLegendModal()"
                        title="Generated: {{ timestamp }}">Legend</button>
                {% if review_mode %}
                <div class="rs-help-menu-container" id="rs-help-menu">
                    <button class="rs-help-menu-btn" id="rs-help-menu-btn" onclick="ReviewSystem.help.toggleHelpMenuFromBtn(this)">
                        <span>? Help</span>
                        <span class="rs-menu-arrow">&#9660;</span>
                    </button>
                    <div class="rs-help-menu-dropdown" id="rs-help-menu-dropdown">
                        <div class="rs-help-menu-section">
                            <button class="rs-help-menu-item" id="rs-menu-tour" onclick="ReviewSystem.help.startTour()">
                                <span class="rs-menu-icon">&#127919;</span>
                                <span class="rs-menu-label">Take Tour</span>
                            </button>
                            <button class="rs-help-menu-item" id="rs-menu-help-panel" onclick="ReviewSystem.help.toggleHelpPanel()">
                                <span class="rs-menu-icon">&#10067;</span>
                                <span class="rs-menu-label">Help Panel</span>
                                <span class="rs-menu-shortcut">?</span>
                            </button>
                        </div>
                        <div class="rs-help-menu-section">
                            <div class="rs-help-menu-section-label">Documentation</div>
                            <a href="/help/quick-start.md" class="rs-help-menu-item" target="_blank">
                                <span class="rs-menu-icon">&#9889;</span>
                                <span class="rs-menu-label">Quick Start</span>
                            </a>
                            <a href="/help/user-guide.md" class="rs-help-menu-item" target="_blank">
                                <span class="rs-menu-icon">&#128218;</span>
                                <span class="rs-menu-label">User Guide</span>
                            </a>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            {% endblock %}

            {# Filter and view controls #}
            {% block filter_controls %}
            <div class="filter-controls">
                <div class="view-toggle">
                    <button class="btn view-btn active" id="btnFlatView" onclick="switchView('flat')">Flat View</button>
                    <button class="btn view-btn" id="btnHierarchyView" onclick="switchView('hierarchy')">Hierarchical View</button>
                    <button class="btn view-btn" id="btnUncommittedView" onclick="switchView('uncommitted')">Uncommitted</button>
                    <button class="btn view-btn" id="btnBranchView" onclick="switchView('branch')">Changed vs Main</button>
                </div>
                <button class="btn toggle-btn" id="btnLeafOnly" onclick="toggleLeafOnly()">üçÉ Leaf Only</button>
                <label class="checkbox-label" title="Include deprecated requirements in counts and views">
                    <input type="checkbox" id="chkIncludeDeprecated" onchange="toggleIncludeDeprecated()">
                    Include deprecated
                </label>
                <label class="checkbox-label" title="Include requirements from spec/roadmap/ directory">
                    <input type="checkbox" id="chkIncludeRoadmap" onchange="toggleIncludeRoadmap()">
                    Include roadmap
                </label>
                <button class="btn btn-secondary" id="btnExpandAll" onclick="expandAll()">‚ñº Expand All</button>
                <button class="btn btn-secondary" id="btnCollapseAll" onclick="collapseAll()">‚ñ∂ Collapse All</button>
                <button class="btn btn-secondary" onclick="clearFilters()">Clear</button>
                <span class="filter-stats" id="filterStats"></span>
                {% if edit_mode or review_mode %}
                <div class="mode-toggle-group">
                    {% if edit_mode %}
                    <button class="mode-toggle-btn" id="btnEditMode" onclick="toggleEditMode()">Edit</button>
                    {% endif %}
                    {% if review_mode %}
                    <button class="mode-toggle-btn" id="btnReviewMode" onclick="ReviewSystem.toggleReviewMode()">Review</button>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            {% endblock %}

            {# Edit mode panel (only shown in edit mode) #}
            {% if edit_mode %}
            {% block edit_mode_panel %}
            <div id="editModePanel" class="edit-mode-panel" style="display: none;">
                <div class="edit-mode-header">
                    <div class="edit-mode-title">
                        <strong>üìù Edit Mode</strong> - Select requirements to move
                        <span id="pendingChangesCount" class="badge" style="margin-left: 10px;">0 pending</span>
                    </div>
                    <div class="edit-mode-actions">
                        <button class="btn btn-secondary" onclick="clearPendingMoves()">Clear Selection</button>
                        <button class="btn" id="btnExportMoves" onclick="generateMoveScript()" disabled>Export Moves JSON</button>
                    </div>
                </div>
                <div class="pending-moves-section">
                    <div class="pending-moves-header" onclick="togglePendingMoves()"
                         style="cursor: pointer; user-select: none; display: flex; align-items: center; margin-bottom: 8px;">
                        <span id="pendingMovesToggle" style="margin-right: 6px; font-size: 12px;">‚ñº</span>
                        <strong style="font-size: 12px;">Pending Moves</strong>
                    </div>
                    <div id="pendingMovesList" class="pending-moves-list"></div>
                </div>
            </div>
            {% endblock %}
            {% endif %}

            {# Tree title #}
            <h2 id="treeTitle">Traceability Tree - Flat View</h2>

            {# Filter header with inputs #}
            {% block filter_header %}
            <div class="filter-header">
                <div class="filter-column">
                    <div class="filter-label">REQ ID</div>
                    <input type="text" id="filterReqId" placeholder="Filter..." oninput="applyFilters()">
                </div>
                <div class="filter-column">
                    <div class="filter-label">Title</div>
                    <input type="text" id="filterTitle" placeholder="Search title..." oninput="applyFilters()">
                </div>
                <div class="filter-column">
                    <div class="filter-label">Level</div>
                    <select id="filterLevel" onchange="applyFilters()">
                        <option value="">All</option>
                        <option value="PRD">PRD</option>
                        <option value="OPS">OPS</option>
                        <option value="DEV">DEV</option>
                    </select>
                </div>
                <div class="filter-column">
                    <div class="filter-label">Status</div>
                    <select id="filterStatus" onchange="applyFilters()">
                        <option value="">All</option>
                        <option value="Active">Active</option>
                        <option value="Draft">Draft</option>
                        <option value="Deprecated">Deprecated</option>
                    </select>
                </div>
                <div class="filter-column">
                    <div class="filter-label">Cov</div>
                    <select id="filterCoverage" onchange="applyFilters()">
                        <option value="">All</option>
                        <option value="full">‚óè</option>
                        <option value="partial">‚óê</option>
                        <option value="none">‚óã</option>
                    </select>
                </div>
                <div class="filter-column">
                    <div class="filter-label">Topic</div>
                    <select id="filterTopic" onchange="applyFilters()">
                        <option value="">All</option>
                        {% for topic in topics %}
                        <option value="{{ topic }}">{{ topic }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            {% endblock %}

            {# Main requirements tree content #}
            {% block requirements_tree %}
            <div class="req-tree" id="reqTree">
                {# Requirements will be inserted here dynamically or server-side #}
                {% block requirements_list %}
                {{ requirements_html|safe }}
                {% endblock %}
            </div>
            {% endblock %}
        </div>
    </div>

    {# Side panel for requirement details (only in embedded mode) #}
    {% if embed_content %}
    {% block side_panel %}
    <div id="req-panel" class="side-panel hidden" style="position: relative;">
        <div class="resize-handle" id="resizeHandle"></div>
        <div class="panel-header">
            <span>Requirements</span>
            <button onclick="closeAllCards()">Close All</button>
        </div>
        <div id="req-card-stack"></div>
    </div>
    {% endblock %}
    {% endif %}

    {# Review panel (third column, only in review mode) #}
    {% if review_mode %}
    {% block review_panel %}
    <div id="review-column" class="review-column hidden">
        <div class="review-resize-handle" id="reviewResizeHandle"></div>

        {# Review packages panel - collapsible section for managing packages #}
        <div class="review-packages-panel" id="reviewPackagesPanel">
            <div class="packages-header" onclick="ReviewSystem.togglePackagesPanel()">
                <span class="collapse-icon">&#9660;</span>
                <h3>Review Packages</h3>
                <button class="create-btn rs-btn" onclick="ReviewSystem.showCreatePackageDialog(event)">+ New Package</button>
                <button class="rs-filter-toggle" id="packageFilterToggle" onclick="ReviewSystem.togglePackageFilter(event)">Show Package REQs</button>
                <span id="packageFilterIndicator"></span>
            </div>
            <div class="packages-content">
                <div class="package-list">
                    {# Package list is rendered by review-packages.js #}
                </div>
            </div>
        </div>

        <div class="review-panel">
            <div class="review-panel-header">
                <span class="review-panel-title">Review Panel</span>
            </div>
            <div class="review-panel-content">
                <div class="review-panel-no-selection">
                    <div class="icon">üí¨</div>
                    <p>Click on a requirement to review it</p>
                    <p><small>Add comments, request status changes, flag for review</small></p>
                </div>
            </div>
        </div>
    </div>
    {% endblock %}
    {% endif %}
</div>

{# JSON data for embedded mode (requirement content) #}
{% if embed_content %}
{% block json_data %}
<script id="req-content-data" type="application/json">
{{ req_json_data|safe }}
</script>
<script>
    // Load REQ content data into global scope
    window.REQ_CONTENT_DATA = JSON.parse(document.getElementById('req-content-data').textContent);
    // Repository root for VS Code links (absolute path required for vscode:// protocol)
    // Note: VS Code links only work on the machine where this file was generated
    window.REPO_ROOT = '{{ repo_root }}';
</script>
{% endblock %}
{% endif %}

{# Review data (only in review mode) #}
{% if review_mode %}
{% block review_data %}
<script id="review-data" type="application/json">
{{ review_json_data|safe }}
</script>
<script>
    // Load review data into global scope
    window.REVIEW_DATA = JSON.parse(document.getElementById('review-data').textContent);
    // Review API endpoint
    window.REVIEW_API_URL = '{{ review_api_url|default("/api/reviews") }}';
</script>
{% endblock %}
{% endif %}

{# Main JavaScript functionality #}
{% block scripts %}
<script>
    {{ js|safe }}
</script>
{% endblock %}

{# Review JavaScript modules (only in review mode) #}
{% if review_mode %}
{% block review_scripts %}
<script>
    {{ review_js|safe }}
</script>
{% endblock %}
{% endif %}

{# Modals (file picker always included, others only in embedded mode) #}
{% block modals %}
{% include 'components/file_picker_modal.html' %}
{% if embed_content %}
{% include 'components/code_viewer_modal.html' %}
{% include 'components/legend_modal.html' %}
{% endif %}
{% endblock %}

{# Help Panel (only in review mode) #}
{% if review_mode %}
{% block help_panel %}
<div class="rs-help-panel hidden" id="rs-help-panel">
    <div class="rs-help-panel-header">
        <h3>Help</h3>
        <button class="rs-btn rs-btn-sm" onclick="ReviewSystem.help.toggleHelpPanel()">&times;</button>
    </div>
    <div class="rs-help-search">
        <input type="text" class="rs-help-search-input" id="rs-help-search" placeholder="Search help..." oninput="ReviewSystem.help.filterHelpContent(this.value)">
    </div>
    <div class="rs-help-sections" id="rs-help-sections">
        <!-- Help sections rendered by JS from help-panel.json -->
    </div>
    <div class="rs-help-footer">
        <div class="rs-help-links">
            <a href="/help/quick-start.md" class="rs-help-link" target="_blank">Quick Start</a>
            <a href="/help/user-guide.md" class="rs-help-link" target="_blank">Full Guide</a>
        </div>
    </div>
</div>
{% endblock %}
{% endif %}

</body>
</html>
