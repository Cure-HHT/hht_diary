#!/bin/bash
# =====================================================
# Commit-Msg Hook: Plugin Orchestrator
# =====================================================
#
# Auto-discovers and executes commit-msg hooks from all
# installed Claude Code plugins via anspar-wf.
#
# Plugin Discovery:
#   Scans: $ANSPAR_WF_PLUGINS/*/hooks/commit-msg (or ~/anspar-wf/plugins/plugins)
#   Executes: All found hooks in alphabetical order
#   Passes: commit message file path as $1 to each hook
#
# To install this hook:
#   git config core.hooksPath .githooks
#
# To bypass (NOT RECOMMENDED):
#   git commit --no-verify
#
# =====================================================

set -e

COMMIT_MSG_FILE="$1"

# =====================================================
# anspar-wf plugin path (installed via pip)
# =====================================================
ANSPAR_PLUGINS="${ANSPAR_WF_PLUGINS:-$HOME/anspar-wf/plugins/plugins}"

# =====================================================
# Auto-Discover and Execute Plugin Hooks
# =====================================================

PLUGIN_DIR="$ANSPAR_PLUGINS"

if [ -d "$PLUGIN_DIR" ]; then
    # Find all plugin commit-msg hooks
    PLUGIN_HOOKS=$(find "$PLUGIN_DIR" -type f -path "*/hooks/commit-msg" 2>/dev/null | sort)

    if [ -n "$PLUGIN_HOOKS" ]; then
        while IFS= read -r hook; do
            PLUGIN_NAME=$(echo "$hook" | sed 's|.*/plugins/\([^/]*\)/.*|\1|')

            # Execute the hook if it's executable
            if [ -x "$hook" ]; then
                if ! "$hook" "$COMMIT_MSG_FILE"; then
                    echo ""
                    echo "‚ùå Plugin hook failed: $PLUGIN_NAME"
                    echo "   Hook: $hook"
                    exit 1
                fi
            fi
        done <<< "$PLUGIN_HOOKS"
    fi
fi

# =====================================================
# All Validations Passed
# =====================================================

exit 0
