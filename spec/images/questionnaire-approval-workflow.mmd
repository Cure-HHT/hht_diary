%%{init: {'flowchart': {'htmlLabels': true, 'nodeSpacing': 60, 'rankSpacing': 60}}}%%
flowchart TD
    subgraph Portal ["Sponsor Portal (Study Coordinator / Investigator)"]
        A["Investigator triggers<br/>push notification"]
        P_S2(["Questionnaire Status:<br/>Ready to Review"])
        G{"Review questionnaire"}
        H["Select: Finalize and Score"]
        J["Score calculated and stored"]
        P_S3(["Questionnaire Status:<br/>Finalized"])
        DEL["Study coordinator<br/>deletes questionnaire"]
        P_DEL(["Questionnaire Status:<br/>Deleted"])
    end

    subgraph Diary ["Diary App (Patient)"]
        B["Patient receives<br/>push notification"]
        D_S1(["Questionnaire Status:<br/>Sent"])
        C["Patient completes<br/>questionnaire"]
        D{"Scored<br/>questionnaire?"}
        E["Review answers<br/>before scoring"]
        F["Select: Complete and Submit"]
        D_S2(["Questionnaire Status:<br/>Ready to Review"])
        EDIT["Patient edits answers<br/>(any time before finalization)"]
        D_S3(["Questionnaire Status:<br/>Read-only permanent"])
    end

    A ==>|"Push notification"| B
    B ==> D_S1
    D_S1 ==> C
    C ==> D
    D ==>|"Yes"| E
    D ==>|"No"| F
    E ==> F
    F ==> D_S2
    D_S2 -.->|"sync"| P_S2
    P_S2 ==> G
    G ==> H
    H ==> J
    J ==> P_S3
    P_S3 -.->|"sync"| D_S3

    %% Patient can edit at any time before finalization
    D_S2 -.->|"patient edits"| EDIT
    EDIT ==>|"returns to In Progress"| C

    %% Delete available from Sent, In Progress, Ready to Review
    D_S1 -.->|"delete"| DEL
    C -.->|"delete"| DEL
    D_S2 -.->|"delete"| DEL
    DEL ==> P_DEL

    %% Portal nodes - blue theme
    style A fill:#1565c0,color:#ffffff,stroke:#0d47a1,stroke-width:3px
    style G fill:#1976d2,color:#ffffff,stroke:#0d47a1,stroke-width:3px
    style H fill:#1565c0,color:#ffffff,stroke:#0d47a1,stroke-width:3px
    style J fill:#0d47a1,color:#ffffff,stroke:#0d47a1,stroke-width:3px
    style DEL fill:#b71c1c,color:#ffffff,stroke:#880e4f,stroke-width:3px

    %% Diary nodes - orange theme
    style B fill:#ef6c00,color:#ffffff,stroke:#e65100,stroke-width:3px
    style C fill:#f57c00,color:#ffffff,stroke:#e65100,stroke-width:3px
    style D fill:#ff9800,color:#000000,stroke:#e65100,stroke-width:3px
    style E fill:#f57c00,color:#ffffff,stroke:#e65100,stroke-width:3px
    style F fill:#ef6c00,color:#ffffff,stroke:#e65100,stroke-width:3px
    style EDIT fill:#f57c00,color:#ffffff,stroke:#e65100,stroke-width:3px

    %% Status nodes - Diary side
    style D_S1 fill:#2e7d32,color:#ffffff,stroke:#1b5e20,stroke-width:3px
    style D_S2 fill:#f9a825,color:#000000,stroke:#f57f17,stroke-width:3px
    style D_S3 fill:#c62828,color:#ffffff,stroke:#b71c1c,stroke-width:3px

    %% Status nodes - Portal side
    style P_S2 fill:#f9a825,color:#000000,stroke:#f57f17,stroke-width:3px
    style P_S3 fill:#c62828,color:#ffffff,stroke:#b71c1c,stroke-width:3px
    style P_DEL fill:#616161,color:#ffffff,stroke:#424242,stroke-width:3px
